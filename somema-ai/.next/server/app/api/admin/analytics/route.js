"use strict";(()=>{var e={};e.id=678,e.ids=[678],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11011:(e,t,a)=>{a.r(t),a.d(t,{patchFetch:()=>m,routeModule:()=>l,serverHooks:()=>h,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>d});var r={};a.r(r),a.d(r,{POST:()=>p});var s=a(96559),n=a(48088),i=a(37719),o=a(32190),c=a(66437),u=a(9682);async function p(e){try{let t=await (0,u.Hk)(e,{requireAuth:!0,requireAdmin:!0,rateLimit:{maxRequests:30,windowMs:9e5}});if(t instanceof o.NextResponse)return t;let a=(0,c.UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),{dateRange:r="30d",includeDetails:s=!1}=await e.json(),n=new Date,i=new Date(n.getFullYear(),n.getMonth(),n.getDate()),p=new Date(i.getTime()-6048e5),l=new Date(i.getTime()-2592e6),{count:g}=await a.from("user_profiles").select("*",{count:"exact",head:!0}),{data:d}=await a.from("user_profiles").select("*").neq("subscription_plan","free"),{data:h}=await a.from("user_profiles").select("*").gte("created_at",i.toISOString()),{data:m}=await a.from("user_profiles").select("*").gte("created_at",p.toISOString()),{data:f}=await a.from("user_profiles").select("*").gte("created_at",l.toISOString()),{data:y}=await a.from("user_profiles").select("subscription_plan, subscription_status"),_={free:0,starter:0,growth:0,scale:0},w={activeSubscriptions:0};y?.forEach(e=>{let t=e.subscription_plan||"free",a=e.subscription_status||"active";_.hasOwnProperty(t)&&_[t]++,"active"===a&&"free"!==t&&w.activeSubscriptions++});let{data:x}=await a.from("user_profiles").select("image_enhancement_credits, subscription_plan"),q=x?.reduce((e,t)=>{let a=function(e){switch(e){case"free":default:return 3;case"starter":return 30;case"growth":return 100;case"scale":return 500}}(t.subscription_plan||"free")-(t.image_enhancement_credits||0);return e+Math.max(0,a)},0)||0,b={starter:999,growth:2499,scale:8999},S={starter:29,growth:79,scale:199},I={starter:83*S.starter,growth:83*S.growth,scale:83*S.scale},v=d?.reduce((e,t)=>{let a=t.subscription_plan,r=t.subscription_status,s=t.country;if("active"===r&&"free"!==a){let t="India"===s||"IN"===s?b[a]||0:I[a]||0;return e+t}return e},0)||0,k=d?.reduce((e,t)=>{let a=t.subscription_plan,r=t.country;if("free"!==a){let t="India"===r||"IN"===r?b[a]||0:I[a]||0;return e+t}return e},0)||0,{data:R}=await a.from("user_profiles").select("city, state, country, subscription_plan, created_at"),A={countries:{},states:{},cities:{},topCountries:[],topStates:[],topCities:[],totalWithLocation:0,totalWithoutLocation:0};R&&(R.forEach(e=>{if(e.city||e.state||e.country){if(A.totalWithLocation++,e.country){let t=e.country;A.countries[t]=(A.countries[t]||0)+1}if(e.state){let t=e.state;A.states[t]=(A.states[t]||0)+1}if(e.city){let t=e.city;A.cities[t]=(A.cities[t]||0)+1}}else A.totalWithoutLocation++}),Object.entries(A.countries).forEach(([e,t])=>{let a=R.filter(t=>t.country===e&&"free"!==t.subscription_plan).reduce((e,t)=>{let a="India"===t.country||"IN"===t.country?b[t.subscription_plan]||0:I[t.subscription_plan]||0;return e+a},0);A.topCountries.push({country:e,count:t,revenue:a})}),Object.entries(A.states).forEach(([e,t])=>{let a=R.filter(t=>t.state===e&&"free"!==t.subscription_plan).reduce((e,t)=>{let a="India"===t.country||"IN"===t.country?b[t.subscription_plan]||0:I[t.subscription_plan]||0;return e+a},0);A.topStates.push({state:e,count:t,revenue:a})}),Object.entries(A.cities).forEach(([e,t])=>{let a=R.filter(t=>t.city===e&&"free"!==t.subscription_plan).reduce((e,t)=>{let a="India"===t.country||"IN"===t.country?b[t.subscription_plan]||0:I[t.subscription_plan]||0;return e+a},0);A.topCities.push({city:e,count:t,revenue:a})}),A.topCountries.sort((e,t)=>t.count-e.count).splice(10),A.topStates.sort((e,t)=>t.count-e.count).splice(10),A.topCities.sort((e,t)=>t.count-e.count).splice(10));let{count:G}=await a.from("posts").select("*",{count:"exact",head:!0}).gte("created_at",i.toISOString()),{count:O}=await a.from("posts").select("*",{count:"exact",head:!0}).gte("created_at",p.toISOString()),{count:T}=await a.from("posts").select("*",{count:"exact",head:!0}).gte("created_at",l.toISOString()),{count:E}=await a.from("generation_logs").select("*",{count:"exact",head:!0}).gte("created_at",i.toISOString()),{count:j}=await a.from("generation_logs").select("*",{count:"exact",head:!0}).gte("created_at",p.toISOString()),{count:C}=await a.from("generation_logs").select("*",{count:"exact",head:!0}).gte("created_at",l.toISOString()),{data:U}=await a.from("generation_logs").select("type, created_at, user_id"),P={gptImage1Requests:0,imageAnalysisRequests:0,captionGenerationRequests:0,hashtagGenerationRequests:0,totalTokens:0},M={imageAnalysis:150,captionGeneration:200,hashtagGeneration:100},N={imageAnalysis:1e-4,captionGeneration:.002,hashtagGeneration:.001,gptImage1:.015};U&&U.forEach(e=>{switch(e.type){case"gpt-image-1":P.gptImage1Requests++;break;case"image-analysis":P.imageAnalysisRequests++,P.totalTokens+=M.imageAnalysis;break;case"caption-generation":P.captionGenerationRequests++,P.totalTokens+=M.captionGeneration;break;case"hashtag-generation":P.hashtagGenerationRequests++,P.totalTokens+=M.hashtagGeneration}});let W={gptImage1:P.gptImage1Requests*N.gptImage1,imageAnalysis:P.imageAnalysisRequests*N.imageAnalysis,captionGeneration:P.captionGenerationRequests*N.captionGeneration,hashtagGeneration:P.hashtagGenerationRequests*N.hashtagGeneration,total:0};W.total=W.gptImage1+W.imageAnalysis+W.captionGeneration+W.hashtagGeneration;let D={totalUsers:g||0,paidUsers:d?.length||0,mrr:v,totalRevenue:k,newUsersToday:h?.length||0,newUsersThisWeek:m?.length||0,newUsersThisMonth:f?.length||0,planDistribution:_,subscriptions:w,creditUsage:{totalCreditsUsed:q},userActivity:{postsCreatedToday:G||0,postsCreatedThisWeek:O||0,postsCreatedThisMonth:T||0,imagesEnhancedToday:E||0,imagesEnhancedThisWeek:j||0,imagesEnhancedThisMonth:C||0},aiUsage:P,totalCosts:W,locationStats:A};return o.NextResponse.json(D)}catch(e){return console.error("Admin analytics error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let l=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/admin/analytics/route",pathname:"/api/admin/analytics",filename:"route",bundlePath:"app/api/admin/analytics/route"},resolvedPagePath:"/Users/thanveerulaklam/Desktop/Projects/Somema/somema-ai/app/api/admin/analytics/route.ts",nextConfigOutput:"",userland:r}),{workAsyncStorage:g,workUnitAsyncStorage:d,serverHooks:h}=l;function m(){return(0,i.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:d})}},11997:e=>{e.exports=require("punycode")},27910:e=>{e.exports=require("stream")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{e.exports=require("tls")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[4447,580,6437,8317],()=>a(11011));module.exports=r})();