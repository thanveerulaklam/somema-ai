(()=>{var e={};e.id=2498,e.ids=[2498],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},9288:e=>{"use strict";e.exports=require("sharp")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},34634:(e,t,o)=>{"use strict";o.r(t),o.d(t,{patchFetch:()=>x,routeModule:()=>d,serverHooks:()=>w,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>f});var r={};o.r(r),o.d(r,{POST:()=>g});var s=o(96559),i=o(48088),a=o(37719),n=o(32190),l=o(66437),c=o(9288),p=o.n(c);let u=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlmbXlwaWtxZ2Vndm9va2p6dnl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NTU3NDMsImV4cCI6MjA2NjMzMTc0M30.BX62nqWwNu23pRQYrzoR9EetesEkac3ZdAu2KKXwNxs",m=(0,l.UU)("https://yfmypikqgegvookjzvyv.supabase.co",u);async function g(e){try{let t,o,{productImageUrl:r,backgroundImageUrl:s,businessName:i}=await e.json();if(!r||!s||!i)return n.NextResponse.json({error:"Missing productImageUrl, backgroundImageUrl, or businessName"},{status:400});console.log("Compositing images..."),console.log("Product image:",r.substring(0,100)+"..."),console.log("Background image:",s.substring(0,100)+"...");let a=async(e,t)=>{if(e.startsWith("data:image/")){let o=e.match(/data:image\/[^;]+;base64,(.+)/);if(!o)throw Error(`Invalid data URL format for ${t}`);let r=o[1];return Buffer.from(r,"base64")}if(e.startsWith("blob:"))throw console.error(`Blob URL received on server side for ${t} - this should not happen`),Error(`Invalid image URL format for ${t}. Please try uploading the image again.`);{let o=await fetch(e);if(!o.ok)throw Error(`Failed to download ${t}: ${o.status}`);let r=await o.arrayBuffer();return Buffer.from(r)}},l=await a(s,"background image"),c=await a(r,"product image");console.log("Compositing images with Sharp...");let u=await p()(Buffer.from(l)).metadata(),g=await p()(Buffer.from(c)).metadata();console.log("Background metadata:",{width:u.width,height:u.height,format:u.format,channels:u.channels}),console.log("Product metadata:",{width:g.width,height:g.height,format:g.format,channels:g.channels,hasAlpha:g.hasAlpha});let d=g.width||512,h=g.height||512;if(d>819.2||h>819.2){let e=Math.min(819.2/d,819.2/h);d=Math.floor(d*e),h=Math.floor(h*e),console.log("Scaling down product to fit background:",{scale:e,newWidth:d,newHeight:h})}if(d<300||h<300){let e=Math.min(Math.max(300/d,300/h),819.2/Math.max(d,h));d=Math.floor(d*e),h=Math.floor(h*e),console.log("Scaling up product for better visibility:",{scale:e,newWidth:d,newHeight:h})}let f=Math.max(0,Math.floor((1024-d)/2)),w=Math.max(0,Math.floor((1024-h)/2));console.log("Product positioning:",{left:f,top:w,width:d,height:h}),console.log("Starting composition with positioning:",{top:w,left:f,productWidth:d,productHeight:h}),d!==g.width||h!==g.height?(console.log("Resizing product image to:",{width:d,height:h}),t=await p()(Buffer.from(c)).resize(d,h,{fit:"inside",withoutEnlargement:!1}).png().toBuffer()):t=Buffer.from(c);try{o=await p()(Buffer.from(l)).resize(1024,1024,{fit:"cover"}).composite([{input:t,top:w,left:f,blend:"over"}]).png().toBuffer()}catch(t){console.error("Composition failed, trying alternative approach:",t),console.log("Using fallback composition with resized product");let e=await p()(Buffer.from(c)).resize(Math.min(600,g.width||600),Math.min(600,g.height||600),{fit:"inside",withoutEnlargement:!1}).png().toBuffer();o=await p()(Buffer.from(l)).resize(1024,1024,{fit:"cover"}).composite([{input:e,top:200,left:200,blend:"over"}]).png().toBuffer()}console.log("Composition completed, buffer size:",o.length);try{let e=await p()(Buffer.from(c)).png().toBuffer();console.log("Product image processed successfully, size:",e.length)}catch(e){console.error("Error processing product image:",e)}console.log("Composite created successfully");let x=Date.now(),b=`composite-${i.replace(/[^a-zA-Z0-9]/g,"-")}-${x}.png`,v=`composites/${b}`;console.log("Uploading composite to Supabase path:",v);let{error:y}=await m.storage.from("media").upload(v,new Blob([o],{type:"image/png"}),{contentType:"image/png",cacheControl:"3600"});if(y)throw console.error("Supabase upload error:",y),Error(`Failed to upload composite: ${y.message}`);console.log("Composite uploaded successfully");let{data:{publicUrl:B}}=m.storage.from("media").getPublicUrl(v);return console.log("Composite URL:",B),n.NextResponse.json({success:!0,compositeUrl:B})}catch(e){return console.error("Image composition error:",e),n.NextResponse.json({error:e.message||"Failed to composite images"},{status:500})}}let d=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/composite-images/route",pathname:"/api/composite-images",filename:"route",bundlePath:"app/api/composite-images/route"},resolvedPagePath:"/Users/thanveerulaklam/Desktop/Projects/Somema/somema-ai/app/api/composite-images/route.ts",nextConfigOutput:"",userland:r}),{workAsyncStorage:h,workUnitAsyncStorage:f,serverHooks:w}=d;function x(){return(0,a.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:f})}},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[4447,580,6437],()=>o(34634));module.exports=r})();