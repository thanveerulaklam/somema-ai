(()=>{var e={};e.id=6949,e.ids=[6949],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10325:(e,r,s)=>{"use strict";s.d(r,{o:()=>a});var t=s(77839);class o{constructor(e){this.accessToken=e.accessToken,this.adAccountId=e.adAccountId,t.ZFN.init(this.accessToken)}async getAdAccounts(){try{console.log("Fetching ad accounts...");let e=await fetch(`https://graph.facebook.com/v18.0/me/adaccounts?access_token=${this.accessToken}`),r=await e.json();if(r.error){console.log("Ads API endpoint failed, trying alternative approach:",r.error.message);let e=await fetch(`https://graph.facebook.com/v18.0/me?fields=id,name&access_token=${this.accessToken}`),s=await e.json();if(s.error)throw Error(s.error.message);return console.log("Successfully made Graph API call to /me endpoint"),[]}return r.data||[]}catch(e){throw console.error("Error fetching ad accounts:",e),e}}async getAdAccountDetails(e){try{let r=await fetch(`https://graph.facebook.com/v18.0/${e}?fields=id,name,account_status,currency,timezone_name&access_token=${this.accessToken}`),s=await r.json();if(s.error)throw Error(s.error.message);return s}catch(e){throw console.error("Error fetching ad account details:",e),e}}async getCampaigns(e){try{let r=await fetch(`https://graph.facebook.com/v18.0/${e}/campaigns?fields=id,name,status,objective&access_token=${this.accessToken}`),s=await r.json();if(s.error)throw Error(s.error.message);return s.data||[]}catch(e){throw console.error("Error fetching campaigns:",e),e}}async getAdSets(e){try{let r=await fetch(`https://graph.facebook.com/v18.0/${e}/adsets?fields=id,name,status,campaign_id&access_token=${this.accessToken}`),s=await r.json();if(s.error)throw Error(s.error.message);return s.data||[]}catch(e){throw console.error("Error fetching ad sets:",e),e}}async getAds(e){try{let r=await fetch(`https://graph.facebook.com/v18.0/${e}/ads?fields=id,name,status,adset_id&access_token=${this.accessToken}`),s=await r.json();if(s.error)throw Error(s.error.message);return s.data||[]}catch(e){throw console.error("Error fetching ads:",e),e}}async getAdAccountInsights(e){try{let r=await fetch(`https://graph.facebook.com/v18.0/${e}/insights?fields=impressions,clicks,spend&date_preset=last_30d&access_token=${this.accessToken}`),s=await r.json();if(s.error){console.log("Insights endpoint failed, trying alternative:",s.error.message);let e=await fetch(`https://graph.facebook.com/v18.0/me/accounts?access_token=${this.accessToken}`),r=await e.json();if(r.error)throw Error(r.error.message);return console.log("Successfully made Graph API call to /me/accounts endpoint"),{data:[],summary:{total_count:0}}}return s}catch(e){throw console.error("Error fetching ad account insights:",e),e}}async getCampaignInsights(e){try{let r=await fetch(`https://graph.facebook.com/v18.0/${e}/insights?fields=impressions,clicks,spend&date_preset=last_30d&access_token=${this.accessToken}`),s=await r.json();if(s.error)throw Error(s.error.message);return s}catch(e){throw console.error("Error fetching campaign insights:",e),e}}async validateToken(){try{let e=await fetch(`https://graph.facebook.com/v18.0/me?access_token=${this.accessToken}`),r=await e.json();if(r.error)return{valid:!1,error:r.error.message};return{valid:!0}}catch(e){return{valid:!1,error:e.message}}}}function a(e){return new o(e)}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},12412:e=>{"use strict";e.exports=require("assert")},21820:e=>{"use strict";e.exports=require("os")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34631:e=>{"use strict";e.exports=require("tls")},38075:(e,r,s)=>{"use strict";s.r(r),s.d(r,{patchFetch:()=>m,routeModule:()=>p,serverHooks:()=>f,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>g});var t={};s.r(t),s.d(t,{GET:()=>d});var o=s(96559),a=s(48088),c=s(37719),i=s(32190),n=s(66437),u=s(10325);let l=(0,n.UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function d(e){try{let r=e.headers.get("authorization"),s=process.env.CRON_SECRET,t=e.headers.get("x-vercel-id"),o=e.headers.get("x-vercel-deployment-url"),a=e.headers.get("x-vercel-cache"),c=e.headers.get("x-matched-path"),n=e.headers.get("host");if(!(t&&(o||a||c)||n&&n.includes("vercel.app")||t)&&(!s||r!==`Bearer ${s}`))return i.NextResponse.json({error:"Unauthorized"},{status:401});console.log("Starting daily Ads API trigger cron job...");let{data:d,error:p}=await l.from("user_profiles").select("user_id, meta_credentials").not("meta_credentials","is",null);if(p)return console.error("Error fetching user profiles:",p),i.NextResponse.json({error:"Failed to fetch user profiles"},{status:500});if(!d||0===d.length)return console.log("No users with Meta credentials found"),i.NextResponse.json({success:!0,message:"No users with Meta credentials found",processed:0});let h=0,g=0,f=0;for(let e of d)try{if(!e.meta_credentials?.accessToken){console.log(`Skipping user ${e.user_id} - no access token`);continue}let r=(0,u.o)({accessToken:e.meta_credentials.accessToken}),s=await r.getAdAccounts();if(s.length>0){let t=s[0];try{await r.getAdAccountInsights(t.id),console.log(`Successfully made Ads API calls for user ${e.user_id}`),g++}catch(r){console.log(`Could not fetch insights for user ${e.user_id}:`,r.message),g++}}else console.log(`No ad accounts found for user ${e.user_id}`),g++;h++}catch(r){console.error(`Error processing user ${e.user_id}:`,r.message),f++}return console.log(`Ads API cron job completed. Processed: ${h}, Success: ${g}, Errors: ${f}`),i.NextResponse.json({success:!0,message:"Daily Ads API trigger completed",processed:h,successful:g,errors:f})}catch(e){return console.error("Ads API cron job error:",e),i.NextResponse.json({error:e.message||"Failed to trigger Ads API calls"},{status:500})}}let p=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/cron/ads-api-trigger/route",pathname:"/api/cron/ads-api-trigger",filename:"route",bundlePath:"app/api/cron/ads-api-trigger/route"},resolvedPagePath:"/Users/thanveerulaklam/Desktop/Projects/Somema/somema-ai/app/api/cron/ads-api-trigger/route.ts",nextConfigOutput:"",userland:t}),{workAsyncStorage:h,workUnitAsyncStorage:g,serverHooks:f}=p;function m(){return(0,c.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:g})}},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},83997:e=>{"use strict";e.exports=require("tty")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[4447,580,6437,139,7839],()=>s(38075));module.exports=t})();