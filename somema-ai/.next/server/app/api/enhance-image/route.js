"use strict";(()=>{var e={};e.id=8792,e.ids=[8792],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},9288:e=>{e.exports=require("sharp")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{e.exports=require("punycode")},27910:e=>{e.exports=require("stream")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{e.exports=require("tls")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},45389:(e,r,t)=>{t.d(r,{Yy:()=>s,rZ:()=>o});let n=(0,t(66437).UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function s(e,r=1){try{let{data:t,error:s}=await n.rpc("atomic_deduct_enhancement_credits",{user_uuid:e,credits_to_deduct:r});if(s)return console.error("Atomic enhancement credit deduction error:",s),{success:!1,newBalance:0,error:s.message};if(!t||0===t.length)return{success:!1,newBalance:0,error:"User not found or insufficient credits"};let o=t[0];if(!o.success)return{success:!1,newBalance:o.current_credits||0,error:o.error||"Insufficient credits"};return{success:!0,newBalance:o.new_credits}}catch(e){return console.error("Enhancement credit deduction error:",e),{success:!1,newBalance:0,error:"Internal server error"}}}async function o(e){try{let{data:r,error:t}=await n.from("user_profiles").select("post_generation_credits, image_enhancement_credits").eq("user_id",e).single();if(r)return{success:!0,credits:{postGenerationCredits:r.post_generation_credits||0,enhancementCredits:r.image_enhancement_credits||0}};if(t&&"PGRST116"!==t.code)return{success:!1,credits:{postGenerationCredits:0,enhancementCredits:0},error:t.message};let s={postGenerationCredits:15,enhancementCredits:3},{data:o,error:a}=await n.from("user_profiles").insert({user_id:e,post_generation_credits:s.postGenerationCredits,image_enhancement_credits:s.enhancementCredits,media_storage_limit:50,subscription_plan:"free"}).select("post_generation_credits, image_enhancement_credits").single();if(a)return console.error("Error creating user profile:",a),{success:!1,credits:{postGenerationCredits:0,enhancementCredits:0},error:a.message};return{success:!0,credits:{postGenerationCredits:o.post_generation_credits,enhancementCredits:o.image_enhancement_credits}}}catch(e){return console.error("Error ensuring user profile:",e),{success:!1,credits:{postGenerationCredits:0,enhancementCredits:0},error:"Internal server error"}}}},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66410:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>_,routeModule:()=>f,serverHooks:()=>w,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>y});var n={};t.r(n),t.d(n,{POST:()=>h});var s=t(96559),o=t(48088),a=t(37719),i=t(32190),l=t(9288),c=t.n(l),u=t(66437),d=t(49485),p=t(9682),g=t(45389),m=t(68803);async function h(e){try{let r,t=await (0,p.Hk)(e,{requireAuth:!0,rateLimit:{maxRequests:10,windowMs:9e5}});if(t instanceof i.NextResponse)return t;let{user:n}=t;if(!n)return i.NextResponse.json({error:"User not found"},{status:401});let s=n.id,o=await e.formData(),a=o.get("image"),l=o.get("productDescription"),h=(0,m.nJ)(a,{required:!0,maxSize:0xa00000,allowedTypes:["image/jpeg","image/jpg","image/png","image/webp"]});if(!h.isValid)return i.NextResponse.json({error:"Invalid file",details:h.errors},{status:400});let f=(0,m.oI)(l,{maxLength:500,sanitize:!0});if(!f.isValid)return i.NextResponse.json({error:"Invalid product description",details:f.errors},{status:400});let x=(0,u.UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),y=await (0,d.eM)(s),w=await (0,d.CX)(s);if(console.log("\uD83D\uDD10 Admin check result for image enhancement:",{userId:s,bypassCredits:y,adminInfo:w}),y)console.log("\uD83D\uDC51 Admin user - bypassing credit check for image enhancement"),r={success:!0,newBalance:999999};else{let e=await (0,g.rZ)(s);if(!e.success)return i.NextResponse.json({error:"Failed to initialize user profile",details:e.error},{status:500});if(!(r=await (0,g.Yy)(s,1)).success)return i.NextResponse.json({error:r.error||"No enhancement credits remaining. Please upgrade your plan or purchase more credits.",creditsRemaining:r.newBalance},{status:402});console.log("✅ Enhancement credit deduction successful. New balance:",r.newBalance)}let _=process.env.OPENAI_API_KEY;if(!_)return i.NextResponse.json({error:"OpenAI API key not configured"},{status:500});let v=Buffer.from(await a.arrayBuffer()),j=await c()(v).resize({width:1024,height:1024,fit:"inside"}).toFormat("jpeg",{quality:90}).toBuffer();console.log(`Image optimized: ${v.length} bytes → ${j.length} bytes (1024x1024 for DALL-E compatibility)`);let b="Enhance the provided product photo into a high-quality professional e-commerce style promotional image. Keep the product's exact colors, textures, proportions, text, and logos 100% unchanged and perfectly preserved. If the product is shown folded, on a mannequin, stand, or prop, replace it with a realistic, attractive model wearing or using the product in the same pose when contextually appropriate. Apply refined background enhancement with realistic detailing, professional lighting, natural shadows, crisp sharpness, reflections, and color correction to achieve commercial-grade aesthetics. Use category-appropriate backgrounds: neutral gradient or light studio for general items, elegant minimal settings for fashion, modern sleek environments for tech, cozy lifestyle interiors for home goods, playful colorful scenes for kids' products, fresh kitchen/dining setups for food, and premium luxurious settings for high-end goods. Ensure the result looks natural, realistic, eye-catching, and ready for Instagram or e-commerce promotion.",I=new FormData;I.append("model","gpt-image-1"),I.append("image",new Blob([j],{type:"image/jpeg"}),"input.jpg"),I.append("prompt",b),I.append("size","1024x1024"),console.log("\uD83D\uDE80 Starting OpenAI image enhancement request..."),console.log("\uD83D\uDCCA Request details:"),console.log("  - Model: gpt-image-1"),console.log("  - Size: 1024x1024"),console.log("  - Input image size:",j.length,"bytes"),console.log("  - Prompt length:",b.length,"characters");let q=await fetch("https://api.openai.com/v1/images/edits",{method:"POST",headers:{Authorization:`Bearer ${_}`},body:I});if(console.log("\uD83D\uDCC8 OpenAI API Response Headers:"),console.log("  - Status:",q.status),console.log("  - Content-Type:",q.headers.get("content-type")),console.log("  - X-Request-ID:",q.headers.get("x-request-id")),console.log("  - X-RateLimit-Limit:",q.headers.get("x-ratelimit-limit")),console.log("  - X-RateLimit-Remaining:",q.headers.get("x-ratelimit-remaining")),console.log("  - X-RateLimit-Reset:",q.headers.get("x-ratelimit-reset")),["openai-processing-ms","openai-version","x-usage-tokens","x-usage-cost"].forEach(e=>{let r=q.headers.get(e);r&&console.log(`  - ${e}:`,r)}),!q.ok){let e=await q.json();if(console.error("❌ OpenAI API Error:",e),e.error?.code==="moderation_blocked"||e.error?.message?.includes("safety system")||e.error?.message?.includes("safety_violations"))return i.NextResponse.json({error:"This image cannot be enhanced due to content policy restrictions. Please try with a different image.",errorType:"safety_violation"},{status:400});return i.NextResponse.json({error:e.error?.message||"OpenAI image generation failed"},{status:500})}let R=await q.json();console.log("✅ OpenAI API Response Data:"),console.log("  - Response structure:",Object.keys(R)),console.log("  - Data array length:",R.data?.length||0),console.log("  - Has b64_json:",!!R.data?.[0]?.b64_json),console.log("  - Has url:",!!R.data?.[0]?.url),R.usage&&(console.log("\uD83D\uDCB0 Usage Information:"),console.log("  - Usage object:",JSON.stringify(R.usage,null,2)));let A=R.data?.[0]?.b64_json;if(!A)return i.NextResponse.json({error:"No image data received from OpenAI API"},{status:500});let k=Buffer.from(A,"base64");console.log("\uD83D\uDCCA Image Processing Results:"),console.log("  - Input image size:",j.length,"bytes"),console.log("  - Output image size:",k.length,"bytes"),console.log("  - Size change:",((k.length-j.length)/j.length*100).toFixed(2)+"%"),console.log("\uD83D\uDCB0 Cost Analysis:"),console.log("  - Model: gpt-image-1 (DALL-E 3)"),console.log("  - Size: 1024x1024"),console.log("  - Quality: Standard"),console.log("  - Estimated cost: $0.0400"),console.log("  - Cost per enhancement: $0.04");let z=`enhanced-${Date.now()}-${Math.random().toString(36).substring(7)}.jpg`,E=`media/enhanced/${z}`,{error:C}=await x.storage.from("media").upload(E,k,{contentType:"image/jpeg",upsert:!0});if(C)return console.error("Failed to upload enhanced image:",C),i.NextResponse.json({error:"Failed to upload enhanced image to storage"},{status:500});let{data:{publicUrl:S}}=x.storage.from("media").getPublicUrl(E);return console.log("Enhanced image uploaded successfully:",S),console.log("\uD83C\uDF89 Image Enhancement Complete!"),console.log("\uD83D\uDCCB Final Summary:"),console.log("  - User ID:",s),console.log("  - Credits remaining:",r.newBalance),console.log("  - Cost per enhancement: $0.04"),console.log("  - Enhanced image URL:",S),i.NextResponse.json({success:!0,enhancedImageUrl:S,creditsRemaining:r.newBalance})}catch(e){return console.error("Enhance image API error:",e),i.NextResponse.json({error:"Internal server error",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let f=new s.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/enhance-image/route",pathname:"/api/enhance-image",filename:"route",bundlePath:"app/api/enhance-image/route"},resolvedPagePath:"/Users/thanveerulaklam/Desktop/Projects/Somema/somema-ai/app/api/enhance-image/route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:x,workUnitAsyncStorage:y,serverHooks:w}=f;function _(){return(0,a.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:y})}},68803:(e,r,t)=>{function n(e,r={}){let t=[],s=e;return r.required&&(null==e||""===e)?(t.push("This field is required"),{isValid:!1,errors:t}):r.required||null!=e&&""!==e?(s=String(e).trim(),r.sanitize&&(s=s.replace(/[<>]/g,"").replace(/javascript:/gi,"").replace(/on\w+=/gi,"")),r.minLength&&s.length<r.minLength&&t.push(`Minimum length is ${r.minLength} characters`),r.maxLength&&s.length>r.maxLength&&t.push(`Maximum length is ${r.maxLength} characters`),r.pattern&&!r.pattern.test(s)&&t.push("Invalid format"),r.allowedValues&&!r.allowedValues.includes(s)&&t.push(`Must be one of: ${r.allowedValues.join(", ")}`),{isValid:0===t.length,errors:t,sanitizedData:s}):{isValid:!0,errors:[],sanitizedData:""}}function s(e,r={}){let t=[];if(r.required&&!e)return t.push("File is required"),{isValid:!1,errors:t};if(!e)return{isValid:!0,errors:[],sanitizedData:null};if(!(e instanceof File))return t.push("Invalid file object"),{isValid:!1,errors:t};if(r.maxSize&&e.size>r.maxSize){let e=Math.round(r.maxSize/1048576);t.push(`File size must be less than ${e}MB`)}return r.allowedTypes&&!r.allowedTypes.includes(e.type)&&t.push(`File type must be one of: ${r.allowedTypes.join(", ")}`),{isValid:0===t.length,errors:t,sanitizedData:e}}function o(e){return function(e,r){let t=[],n={};if("object"!=typeof e||null===e||Array.isArray(e))return{isValid:!1,errors:["Input must be a valid object"]};for(let[s,o]of Object.entries(r)){let r=o(e[s]);r.isValid?n[s]=r.sanitizedData:t.push(...r.errors.map(e=>`${s}: ${e}`))}return{isValid:0===t.length,errors:t,sanitizedData:n}}(e,{businessContext:e=>n(e,{required:!0,minLength:3,maxLength:500,sanitize:!0}),platform:e=>n(e,{allowedValues:["instagram","facebook","twitter","linkedin","tiktok"]}),theme:e=>n(e,{maxLength:100,sanitize:!0}),tone:e=>n(e,{allowedValues:["professional","casual","friendly","authoritative","playful","inspiring"]}),targetAudience:e=>n(e,{maxLength:200,sanitize:!0}),niche:e=>n(e,{maxLength:100,sanitize:!0})})}t.d(r,{UT:()=>o,nJ:()=>s,oI:()=>n})},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[4447,580,6437,8317],()=>t(66410));module.exports=n})();