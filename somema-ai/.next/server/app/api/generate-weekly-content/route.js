"use strict";(()=>{var e={};e.id=461,e.ids=[461],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{e.exports=require("punycode")},27910:e=>{e.exports=require("stream")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{e.exports=require("tls")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},84811:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>f,routeModule:()=>p,serverHooks:()=>m,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{POST:()=>d});var n=r(96559),o=r(48088),a=r(37719),i=r(32190),c=r(28695),u=r(66437),l=r(49485);async function d(e){try{let{imageSelections:t,userProfile:r,platform:s}=await e.json();if(!t||!r)return i.NextResponse.json({error:"Missing required parameters: imageSelections and userProfile"},{status:400});let n=e.headers.get("authorization");if(!n)return i.NextResponse.json({error:"Authorization header required"},{status:401});let o=n.replace("Bearer ","");if(!o)return i.NextResponse.json({error:"Invalid user ID"},{status:401});let a=await (0,l.eM)(o),d=await (0,l.CX)(o);console.log("\uD83D\uDD10 Admin check result:",{userId:o,bypassCredits:a,adminInfo:d});let p=(0,u.UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),{data:g,error:h}=await p.from("user_profiles").select("post_generation_credits, subscription_plan").eq("user_id",o).single();if(h)return console.error("Error fetching user credits:",h),i.NextResponse.json({error:"Failed to check user credits"},{status:500});let m=g?.post_generation_credits||0,f=Object.keys(t).length;if(!a&&m<f)return i.NextResponse.json({error:`Insufficient post generation credits. You need ${f} credits but only have ${m} remaining. Please upgrade your plan or purchase more credits.`,creditsRemaining:m,creditsNeeded:f},{status:402});a&&console.log("\uD83D\uDC51 Admin user - bypassing credit check for weekly content generation"),console.log("Generating weekly content with:",{imageSelections:Object.keys(t).length,userProfile:{business_name:r.business_name,industry:r.industry,brand_tone:r.brand_tone,target_audience:r.target_audience},platform:s,creditsRemaining:m});let y=[];for(let[s,n]of Object.entries(t))if(n&&Array.isArray(n)&&0!==n.length)try{let a,i=e.headers.get("origin")||"http://localhost:3000",u=[],l=!1;for(let e of n)if(e.mime_type&&e.mime_type.startsWith("video/"))l=!0,console.log(`ðŸŽ¥ Video detected in weekly content: ${e.file_name} - skipping analysis`);else{let t=await fetch(`${i}/api/analyze-image`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({imageUrl:e.file_path})});if(!t.ok)throw Error("Failed to analyze image");let r=await t.json();u.push(r.analysis)}if(l){console.log("\uD83C\uDFA5 Generating video content directly from business profile for weekly post");let e={businessContext:r.business_name||"our business",platform:"instagram",theme:"reel",customPrompt:`Create engaging Instagram Reel content for ${r.business_name||"our business"}. Business type: ${r.industry||"general business"}. Target audience: ${r.target_audience||"general audience"}.`,tone:r.brand_tone||"friendly",targetAudience:r.target_audience||"General audience",niche:r.industry||"General"},t=await fetch(`${i}/api/generate-video-content`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({request:e})});if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to generate video content")}let s=await t.json();a={caption:s.result?.caption||"",hashtags:s.result?.hashtags||[]}}else{let e=u.map(e=>e.caption).join(" | "),t=Array.from(new Set(u.flatMap(e=>e.tags))),s=u.reduce((e,t)=>(e[t.classification]=(e[t.classification]||0)+1,e),{}),n=Object.entries(s),o=n.length>0?n.sort((e,t)=>t[1]-e[1])[0][0]:"Product",i=u.reduce((e,t)=>e+(t.confidence||0),0)/u.length,l={caption:e,classification:o,tags:t,confidence:i},d={business_name:r.business_name||"Our Business",niche:r.industry||"General",tone:r.brand_tone||"Professional",audience:r.target_audience||"Our customers"};a=await (0,c.fX)(l,d)}let d=Object.keys(t).indexOf(s),p=new Date;p.setDate(p.getDate()+d+1),p.setHours(9,0,0,0),y.push({dayKey:s,theme:l?"Video Content":u.length>0?"Product":"Video Content",caption:a.caption,hashtags:a.hashtags,imagePrompt:l?"Video content generated from business profile":u.length>0?u.map(e=>e.caption).join(" | "):"Video content",selectedImages:n,mediaUrls:n.map(e=>e.file_path),scheduledFor:p.toISOString()})}catch(a){console.error(`Error generating content for ${s}:`,a);let e=Object.keys(t).indexOf(s),o=new Date;o.setDate(o.getDate()+e+1),o.setHours(9,0,0,0),y.push({dayKey:s,theme:"Product Showcase",caption:`Check out this amazing product from ${r.business_name||"our business"}!`,hashtags:["product","amazing","checkitout"],imagePrompt:"Product showcase",selectedImages:n,mediaUrls:n.map(e=>e.file_path),scheduledFor:o.toISOString()})}console.log("Generated weekly content:",y);let w=y.filter(e=>e.caption&&"Check out this amazing product from Brand E!"!==e.caption&&e.hashtags&&e.hashtags.length>0);try{let e=m-w.length,{error:t}=await p.from("user_profiles").update({post_generation_credits:e}).eq("user_id",o);t?console.error("Failed to update user credits:",t):(console.log(`âœ… Credits deducted: ${w.length} (successful posts) out of ${y.length} (total posts)`),console.log(`ðŸ“Š Credits remaining: ${e}`));let r=w.map(()=>({user_id:o,type:"weekly"}));r.length>0&&await p.from("generation_logs").insert(r)}catch(e){console.error("Failed to log weekly generation:",e)}return i.NextResponse.json({success:!0,generatedPosts:y})}catch(e){return console.error("Error generating weekly content:",e),i.NextResponse.json({error:e.message||"Failed to generate weekly content"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/generate-weekly-content/route",pathname:"/api/generate-weekly-content",filename:"route",bundlePath:"app/api/generate-weekly-content/route"},resolvedPagePath:"/Users/thanveerulaklam/Desktop/Projects/Somema/somema-ai/app/api/generate-weekly-content/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:g,workUnitAsyncStorage:h,serverHooks:m}=p;function f(){return(0,a.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:h})}},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4447,580,6437,7774],()=>r(84811));module.exports=s})();