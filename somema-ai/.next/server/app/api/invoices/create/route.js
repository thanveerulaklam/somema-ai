(()=>{var e={};e.id=7393,e.ids=[7393],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},12412:e=>{"use strict";e.exports=require("assert")},21820:e=>{"use strict";e.exports=require("os")},24031:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>b,routeModule:()=>d,serverHooks:()=>g,workAsyncStorage:()=>_,workUnitAsyncStorage:()=>y});var s={};t.r(s),t.d(s,{POST:()=>p});var n=t(96559),a=t(48088),o=t(37719),i=t(32190),u=t(95457),l=t.n(u);let c=(0,t(66437).UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),m=new(l())({key_id:process.env.RAZORPAY_KEY_ID,key_secret:process.env.RAZORPAY_KEY_SECRET});async function p(e){try{let r;console.log("\uD83E\uDDFE Creating Razorpay Invoice...");let{userId:t,planId:s,billingCycle:n="monthly",customerType:a="individual",businessInfo:o={},billingInfo:u={}}=await e.json();if(console.log("\uD83D\uDCCB Request data:",{userId:t,planId:s,billingCycle:n,customerType:a}),console.log("\uD83D\uDD0D User ID type:",typeof t,"Value:",t),!t||!s)return i.NextResponse.json({error:"Missing required fields"},{status:400});let{data:l,error:p}=await c.auth.admin.getUserById(t);if(p||!l.user){console.error("❌ Auth user error:",p),console.error("❌ User ID:",t);let{data:e,error:s}=await c.from("user_profiles").select("*").eq("user_id",t).single();if(s||!e)return i.NextResponse.json({error:"User not found"},{status:404});r={id:t,email:e.invoice_email||"unknown@example.com",user_metadata:{full_name:e.business_name||"Unknown User"}},console.log("✅ Using fallback user data:",r)}else r=l.user;console.log("\uD83D\uDD0D User ID comparison:",{requestUserId:t,userObjectId:r.id,match:t===r.id});let{data:d,error:_}=await c.from("user_profiles").select("*").eq("user_id",t).single(),y=d;if(_&&"PGRST116"===_.code){let{data:e,error:s}=await c.from("user_profiles").insert({user_id:t,customer_type:a,invoice_email:r.email,post_generation_credits:15,image_enhancement_credits:3,media_storage_limit:50,subscription_plan:"free"}).select().single();if(s)return console.error("Error creating user profile:",s),i.NextResponse.json({error:"Failed to create user profile"},{status:500});y=e}if(y&&!y.customer_type){let{data:e,error:r}=await c.from("user_profiles").update({customer_type:a}).eq("user_id",t).select().single();r?console.error("Error updating user profile:",r):y=e}let g={...r,...y},b={starter:{monthly:{amount:99900,name:"Starter Plan - Monthly"},yearly:{amount:999e3,name:"Starter Plan - Yearly"}},growth:{monthly:{amount:249900,name:"Growth Plan - Monthly"},yearly:{amount:2499e3,name:"Growth Plan - Yearly"}},scale:{monthly:{amount:899900,name:"Scale Plan - Monthly"},yearly:{amount:8999e3,name:"Scale Plan - Yearly"}}}[s]?.[n];if(!b)return i.NextResponse.json({error:"Invalid plan or billing cycle"},{status:400});let v=b.amount,f=o.businessName||g.business_name,x="business"===a||"business"===g.customer_type||f&&"Unknown"!==f&&"Customer"!==f,h=o.gstNumber||g.gst_number;console.log("\uD83C\uDFE2 Customer type analysis:",{customerType:a,userCustomerType:g.customer_type,isBusinessClient:x,hasGstNumber:h,businessName:o.businessName||g.business_name});let q=0,w=0,S=0,R=0;x&&h?(R=18,q=Math.round(v*R/100),w=Math.round(q/2),S=Math.round(q/2)):x&&!h&&(R=18,q=Math.round(v*R/100),w=Math.round(q/2),S=Math.round(q/2));let k=v+q,{data:I}=await c.rpc("generate_invoice_number");console.log("\uD83D\uDD22 Generated invoice number:",I);let N=I||`INV-${Date.now()}`,P=`temp_${Date.now()}@${g.email?g.email.split("@")[1]:"example.com"}`,U={name:g.user_metadata?.full_name||o.businessName||"Customer",email:P,contact:g.user_metadata?.phone||o.phone||"",gstin:h?o.gstNumber||g.gst_number:null,billing_address:{name:g.user_metadata?.full_name||o.businessName,line1:u.address||g.billing_address?.line1||"",line2:u.address2||g.billing_address?.line2||"",city:u.city||g.billing_address?.city||"",state:u.state||g.billing_address?.state||"",country:"IN",zipcode:u.pincode||g.billing_address?.pincode||""}},A=[{name:b.name,description:`${b.name} subscription`,amount:v,quantity:1,unit:"nos"}];q>0&&(w>0&&A.push({name:"CGST",description:"Central GST @ 9%",amount:w,quantity:1,unit:"nos"}),S>0&&A.push({name:"SGST",description:"State GST @ 9%",amount:S,quantity:1,unit:"nos"}));let j={type:"invoice",description:`Subscription for ${b.name}`,partial_payment:!1,customer:U,line_items:A,currency:"INR",receipt:N,notes:{plan_id:s,billing_cycle:n,customer_type:a,gst_applied:q>0?"true":"false",user_id:t,business_name:o.businessName||g.business_name}};console.log("\uD83D\uDCCB Creating Razorpay invoice with data:",j);let E=await m.invoices.create(j);console.log("\uD83D\uDCBE Saving invoice to database...");let{error:C}=await c.from("invoices").insert({razorpay_invoice_id:E.id,user_id:t,invoice_number:E.invoice_number||N,plan_id:s,billing_cycle:n,customer_name:U.name,customer_email:U.email,customer_phone:U.contact||"",customer_type:a,business_name:o.businessName||g.business_name||null,gst_number:U.gstin||null,business_address:null,billing_address:U.billing_address||null,base_amount:v,tax_amount:q,total_amount:k,currency:"INR",gst_rate:R,cgst_amount:(A&&Array.isArray(A)?A.find(e=>"CGST"===e.name)?.amount:0)||0,sgst_amount:(A&&Array.isArray(A)?A.find(e=>"SGST"===e.name)?.amount:0)||0,igst_amount:(A&&Array.isArray(A)?A.find(e=>"IGST"===e.name)?.amount:0)||0,is_export:!1,status:"sent",due_date:new Date(Date.now()+2592e6).toISOString(),invoice_data:E});return C?console.error("❌ Error saving invoice to database:",C):console.log("✅ Invoice saved to database successfully"),console.log("✅ Invoice created successfully:",E.id),console.log("\uD83D\uDCB3 Payment URL:",E.short_url),i.NextResponse.json({success:!0,invoice:{razorpay_invoice_id:E.id,invoice_number:E.invoice_number||N,short_url:E.short_url,status:E.status,amount:k,base_amount:v,tax_amount:q,gst_rate:R,due_date:new Date(Date.now()+2592e6).toISOString()}})}catch(e){return console.error("❌ Error creating invoice:",e),i.NextResponse.json({error:"Failed to create invoice",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/invoices/create/route",pathname:"/api/invoices/create",filename:"route",bundlePath:"app/api/invoices/create/route"},resolvedPagePath:"/Users/thanveerulaklam/Desktop/Projects/Somema/somema-ai/app/api/invoices/create/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:_,workUnitAsyncStorage:y,serverHooks:g}=d;function b(){return(0,o.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:y})}},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},83997:e=>{"use strict";e.exports=require("tty")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4447,580,6437,139,5457],()=>t(24031));module.exports=s})();