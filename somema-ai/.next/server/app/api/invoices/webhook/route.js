(()=>{var e={};e.id=684,e.ids=[684],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55400:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>x,routeModule:()=>y,serverHooks:()=>w,workAsyncStorage:()=>b,workUnitAsyncStorage:()=>f});var i={};t.r(i),t.d(i,{POST:()=>p});var o=t(96559),n=t(48088),s=t(37719),a=t(32190),c=t(66437),u=t(55511),d=t.n(u);let l=(0,c.UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function p(e){try{console.log("\uD83D\uDD14 Razorpay Invoice Webhook received");let r=await e.text(),t=e.headers.get("x-razorpay-signature");if(!t)return console.error("❌ Missing signature in webhook"),a.NextResponse.json({error:"Missing signature"},{status:400});let i=d().createHmac("sha256",process.env.RAZORPAY_WEBHOOK_SECRET).update(r).digest("hex");if(t!==i)return console.error("❌ Invalid webhook signature"),a.NextResponse.json({error:"Invalid signature"},{status:400});let o=JSON.parse(r);switch(console.log("\uD83D\uDCCB Webhook event:",o.event),o.event){case"invoice.paid":await _(o.payload.invoice.entity);break;case"invoice.cancelled":await m(o.payload.invoice.entity);break;case"invoice.expired":await v(o.payload.invoice.entity);break;default:console.log("ℹ️ Unhandled webhook event:",o.event)}return a.NextResponse.json({success:!0})}catch(e){return console.error("❌ Webhook processing error:",e),a.NextResponse.json({error:"Webhook processing failed",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function _(e){console.log("\uD83D\uDCB0 Invoice paid:",e.id);try{let{data:r,error:t}=await l.from("invoices").select("*").eq("razorpay_invoice_id",e.id).single();if(t&&"PGRST116"!==t.code)return void console.error("❌ Error fetching invoice:",t);if(r){let{error:r}=await l.from("invoices").update({status:"paid",paid_at:new Date().toISOString(),razorpay_payment_id:e.payment_id,updated_at:new Date().toISOString()}).eq("razorpay_invoice_id",e.id);if(r)return void console.error("❌ Error updating invoice status:",r)}else{console.log("\uD83D\uDCDD Creating invoice record in database after payment...");let r=e.notes?.user_id;if(!r)return void console.error("❌ No user_id found in invoice notes");let t=e.line_items&&Array.isArray(e.line_items)?e.line_items:[],i=t.find(e=>!e.name.includes("GST"))?.amount||0,o=t.filter(e=>e.name.includes("GST")).reduce((e,r)=>e+r.amount,0)||0,n=e.amount,{error:s}=await l.from("invoices").insert({razorpay_invoice_id:e.id,user_id:r,invoice_number:e.invoice_number,plan_id:e.notes?.plan_id||"unknown",billing_cycle:e.notes?.billing_cycle||"monthly",customer_name:e.customer_details?.name||"Customer",customer_email:e.customer_details?.email||"",customer_phone:e.customer_details?.contact||"",customer_type:e.notes?.customer_type||"individual",business_name:e.notes?.business_name||null,gst_number:e.customer_details?.gstin||null,business_address:null,billing_address:e.customer_details?.billing_address||null,base_amount:i,tax_amount:o,total_amount:n,currency:e.currency||"INR",gst_rate:18*(e.notes?.gst_applied==="true"),cgst_amount:t.find(e=>"CGST"===e.name)?.amount||0,sgst_amount:t.find(e=>"SGST"===e.name)?.amount||0,igst_amount:t.find(e=>"IGST"===e.name)?.amount||0,is_export:!1,status:"paid",due_date:new Date(Date.now()+2592e6).toISOString(),paid_at:new Date().toISOString(),razorpay_payment_id:e.payment_id,invoice_data:e});if(s)return void console.error("❌ Error creating invoice record:",s);console.log("✅ Invoice record created in database")}let{data:i,error:o}=await l.from("invoices").select("*").eq("razorpay_invoice_id",e.id).single();if(o||!i)return void console.error("❌ Error fetching invoice data:",o);let n={subscription_plan:i.plan_id,subscription_status:"active",subscription_start_date:new Date().toISOString(),subscription_end_date:g(i.billing_cycle),billing_cycle:i.billing_cycle},{error:s}=await l.from("users").update(n).eq("id",i.user_id);s?console.error("❌ Error updating user subscription:",s):console.log("✅ User subscription activated for:",i.user_id);let{error:a}=await l.from("subscriptions").insert({user_id:i.user_id,plan_id:i.plan_id,status:"active",current_start_date:new Date().toISOString(),current_end_date:g(i.billing_cycle),amount:i.base_amount,currency:i.currency,billing_cycle:i.billing_cycle});a&&console.error("❌ Error creating subscription record:",a)}catch(e){console.error("❌ Error handling invoice paid:",e)}}async function m(e){console.log("❌ Invoice cancelled:",e.id);try{let{error:r}=await l.from("invoices").update({status:"cancelled",updated_at:new Date().toISOString()}).eq("razorpay_invoice_id",e.id);r&&console.error("❌ Error updating invoice status:",r)}catch(e){console.error("❌ Error handling invoice cancelled:",e)}}async function v(e){console.log("⏰ Invoice expired:",e.id);try{let{error:r}=await l.from("invoices").update({status:"expired",updated_at:new Date().toISOString()}).eq("razorpay_invoice_id",e.id);r&&console.error("❌ Error updating invoice status:",r)}catch(e){console.error("❌ Error handling invoice expired:",e)}}function g(e){let r=new Date;switch(e){case"monthly":default:return new Date(r.getTime()+2592e6).toISOString();case"yearly":return new Date(r.getTime()+31536e6).toISOString()}}let y=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/invoices/webhook/route",pathname:"/api/invoices/webhook",filename:"route",bundlePath:"app/api/invoices/webhook/route"},resolvedPagePath:"/Users/thanveerulaklam/Desktop/Projects/Somema/somema-ai/app/api/invoices/webhook/route.ts",nextConfigOutput:"",userland:i}),{workAsyncStorage:b,workUnitAsyncStorage:f,serverHooks:w}=y;function x(){return(0,s.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:f})}},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[4447,580,6437],()=>t(55400));module.exports=i})();