"use strict";(()=>{var e={};e.id=7658,e.ids=[7658],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{e.exports=require("punycode")},12412:e=>{e.exports=require("assert")},16896:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>k,routeModule:()=>h,serverHooks:()=>j,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>q});var s={};r.r(s),r.d(s,{DELETE:()=>m,GET:()=>d,PATCH:()=>x,POST:()=>g});var o=r(96559),a=r(48088),n=r(37719),c=r(32190),i=r(66437),u=r(33900);let p=(0,i.UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function l(e){let{data:t,error:r}=await p.from("user_profiles").select("meta_credentials").eq("user_id",e).single();return r||!t?.meta_credentials?null:t.meta_credentials}async function d(e){try{let t=e.headers.get("authorization");if(!t)return c.NextResponse.json({error:"Authorization header required"},{status:401});let r=t.replace("Bearer ",""),s=await l(r);if(!s?.accessToken)return c.NextResponse.json({error:"Meta account not connected"},{status:404});let o=s.pages||[];console.log(`Using ${o.length} stored pages from database`);let a=o,n=o;if(0===o.length){console.log("No stored pages found, fetching from Meta API...");let e=(0,u.b)({accessToken:s.accessToken});try{n=await e.getFacebookPages(),console.log(`✅ Fetched ${n.length} Facebook pages`),a=await Promise.all(n.map(async t=>{console.log(`Getting Instagram accounts for page: ${t.name} (${t.id})`);let r=await e.getInstagramAccounts(t.id);return{...t,instagram_accounts:r}})),console.log(`✅ Processed ${a.length} pages with Instagram accounts`)}catch(t){console.error("Error fetching from Meta API:",t);try{let t=await fetch(`https://graph.facebook.com/v18.0/me/accounts?fields=id,name,category,category_list,tasks,access_token&access_token=${s.accessToken}&limit=100`),r=await t.json();!r.error&&r.data&&(n=r.data,a=await Promise.all(n.map(async t=>{let r=await e.getInstagramAccounts(t.id);return{...t,instagram_accounts:r}})))}catch(e){console.error("Fallback fetch also failed:",e)}}}return c.NextResponse.json({success:!0,available:a,connected:s.connected||[],debug:{facebookPagesRaw:n}})}catch(e){return console.error("Error fetching Meta pages:",e),c.NextResponse.json({error:e.message||"Failed to fetch Meta pages"},{status:500})}}async function g(e){try{let{pageId:t,instagramId:r}=await e.json(),s=e.headers.get("authorization");if(!s)return c.NextResponse.json({error:"Authorization header required"},{status:401});let o=s.replace("Bearer ",""),a=await l(o);if(!a?.accessToken)return c.NextResponse.json({error:"Meta account not connected"},{status:404});let n=[{pageId:t,instagramId:r}],{error:i}=await p.from("user_profiles").update({meta_credentials:{...a,connected:n}}).eq("user_id",o);if(i)return c.NextResponse.json({error:"Failed to connect page/account"},{status:500});return c.NextResponse.json({success:!0,connected:n})}catch(e){return console.error("Meta connect error:",e),c.NextResponse.json({error:e.message||"Failed to connect page/account"},{status:500})}}async function m(e){try{let{pageId:t,instagramId:r}=await e.json(),s=e.headers.get("authorization");if(!s)return c.NextResponse.json({error:"Authorization header required"},{status:401});let o=s.replace("Bearer ",""),a=await l(o);if(!a?.accessToken)return c.NextResponse.json({error:"Meta account not connected"},{status:404});let n=a.connected||[];n=n.filter(e=>e.pageId!==t||e.instagramId!==r);let{error:i}=await p.from("user_profiles").update({meta_credentials:{...a,connected:n}}).eq("user_id",o);if(i)return c.NextResponse.json({error:"Failed to disconnect page/account"},{status:500});return c.NextResponse.json({success:!0,connected:n})}catch(e){return console.error("Meta disconnect error:",e),c.NextResponse.json({error:e.message||"Failed to disconnect page/account"},{status:500})}}async function x(e){try{let t=e.headers.get("authorization");if(!t)return c.NextResponse.json({error:"Authorization header required"},{status:401});let r=t.replace("Bearer ",""),s=await l(r);if(!s?.accessToken)return c.NextResponse.json({error:"Meta account not connected"},{status:404});let o=s.connected||[],a=o;if(o.length>1){a=[o[0]];let{error:e}=await p.from("user_profiles").update({meta_credentials:{...s,connected:a}}).eq("user_id",r);if(e)return c.NextResponse.json({error:"Failed to clean up connections"},{status:500})}return c.NextResponse.json({success:!0,connected:a,message:o.length>1?`Cleaned up ${o.length} connections to single connection`:"No cleanup needed"})}catch(e){return console.error("Meta cleanup error:",e),c.NextResponse.json({error:e.message||"Failed to clean up connections"},{status:500})}}let h=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/meta/connect/route",pathname:"/api/meta/connect",filename:"route",bundlePath:"app/api/meta/connect/route"},resolvedPagePath:"/Users/thanveerulaklam/Desktop/Projects/Somema/somema-ai/app/api/meta/connect/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:f,workUnitAsyncStorage:q,serverHooks:j}=h;function k(){return(0,n.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:q})}},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4447,580,6437,139,7839,5759],()=>r(16896));module.exports=s})();