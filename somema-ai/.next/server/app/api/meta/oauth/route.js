(()=>{var e={};e.id=7465,e.ids=[7465],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},12502:(e,o,t)=>{"use strict";t.r(o),t.d(o,{patchFetch:()=>E,routeModule:()=>k,serverHooks:()=>w,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>v});var s={};t.r(s),t.d(s,{GET:()=>$});var a=t(96559),n=t(48088),r=t(37719),c=t(32190);let i=(0,t(66437).UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),l=process.env.META_APP_ID,g=process.env.META_APP_SECRET;function d(e){let o=e.headers.get("host")||"";return o.includes("localhost")||o.includes("127.0.0.1")?"http://localhost:3000":(process.env.META_REDIRECT_URI||"https://www.quely.ai/api/meta/oauth").replace("/api/meta/oauth","")}async function u(e){let o=[],t=`https://graph.facebook.com/v18.0/me/accounts?fields=id,name,category,category_list,tasks,access_token&access_token=${e}&limit=100`;for(;t;){console.log("Fetching pages from:",t);let e=await fetch(t),s=await e.json();if(console.log("Page fetch response:",JSON.stringify(s,null,2)),s.error)throw console.error("âŒ Page fetch error:",s.error),Error(`Failed to fetch pages: ${s.error.message}`);s.data&&Array.isArray(s.data)&&(o=o.concat(s.data),console.log(`âœ… Fetched ${s.data.length} pages in this batch`)),t=s.paging?.next||null}return console.log(`ðŸ“Š Total pages fetched: ${o.length}`),o}async function p(e){let o=[];try{let t=await fetch(`https://graph.facebook.com/v18.0/me/businesses?fields=id,name&access_token=${e}`),s=await t.json();if(console.log("Business accounts response:",s),s.error)return console.log("No business accounts or error:",s.error.message),[];if(s.data&&s.data.length>0)for(let t of(console.log(`Found ${s.data.length} business accounts`),s.data)){console.log(`Fetching pages for business: ${t.name} (ID: ${t.id})`);let s=`https://graph.facebook.com/v18.0/${t.id}/owned_pages?fields=id,name,category,category_list,tasks,access_token&access_token=${e}&limit=100`;for(;s;){let e=await fetch(s),a=await e.json();if(console.log(`Business pages response for ${t.name}:`,a),a.error){console.log(`Error fetching pages for business ${t.name}:`,a.error.message);break}a.data&&Array.isArray(a.data)&&(o=o.concat(a.data),console.log(`Found ${a.data.length} pages in business ${t.name}`)),s=a.paging?.next||null}}}catch(e){console.log("Error fetching business pages:",e)}return console.log(`ðŸ“Š Total business pages fetched: ${o.length}`),o}async function h(e,o){let t=[];try{let s=await fetch(`https://graph.facebook.com/v18.0/${e}?fields=instagram_business_account,connected_instagram_account&access_token=${o}`),a=await s.json();if(console.log(`Instagram data for page ${e}:`,JSON.stringify(a,null,2)),a.instagram_business_account){console.log(`âœ… Found Instagram Business Account for page ${e}`);let s=await fetch(`https://graph.facebook.com/v18.0/${a.instagram_business_account.id}?fields=id,username,name&access_token=${o}`),n=await s.json();n.error?console.log(`âŒ Error getting Instagram business details:`,n.error):(t.push(n),console.log(`âœ… Added Instagram Business: ${n.username} (${n.id})`))}if(a.connected_instagram_account&&(!a.instagram_business_account||a.connected_instagram_account.id!==a.instagram_business_account.id)){console.log(`âœ… Found Connected Instagram Account for page ${e}`);let s=await fetch(`https://graph.facebook.com/v18.0/${a.connected_instagram_account.id}?fields=id,username,name&access_token=${o}`),n=await s.json();n.error?console.log(`âŒ Error getting connected Instagram details:`,n.error):(t.push(n),console.log(`âœ… Added Connected Instagram: ${n.username} (${n.id})`))}try{let s=await fetch(`https://graph.facebook.com/v18.0/${e}/instagram_accounts?fields=id,username,name&access_token=${o}`),a=await s.json();if(!a.error&&a.data&&Array.isArray(a.data))for(let o of(console.log(`âœ… Found ${a.data.length} Instagram accounts through edge for page ${e}`),a.data))t.some(e=>e.id===o.id)||(t.push(o),console.log(`âœ… Added Instagram via edge: ${o.username} (${o.id})`))}catch(o){console.log(`â„¹ï¸  Instagram edge not available for page ${e}:`,o)}}catch(o){console.error(`âŒ Error getting Instagram accounts for page ${e}:`,o)}return console.log(`ðŸ“Š Total Instagram accounts for page ${e}: ${t.length}`),t}async function m(e){let o=[];console.log("=== ENHANCED PAGE DISCOVERY FOR REGULAR USERS ==="),console.log("Method 1: Fetching direct pages from /me/accounts...");try{let t=await u(e);o=o.concat(t),console.log(`âœ… Method 1: Found ${t.length} direct pages`)}catch(e){console.error("âŒ Method 1 failed:",e.message)}console.log("Method 2: Fetching pages via user accounts edge...");try{let t=await fetch(`https://graph.facebook.com/v18.0/me?fields=accounts{id,name,category,category_list,tasks,access_token}&access_token=${e}&limit=100`),s=await t.json();if(!s.error&&s.accounts&&s.accounts.data){let e=s.accounts.data;for(let t of(console.log(`âœ… Method 2: Found ${e.length} pages via user accounts edge`),e))0>o.findIndex(e=>e.id===t.id)&&(o.push(t),console.log(`âœ… Added new page via user accounts: ${t.name}`))}}catch(e){console.error("âŒ Method 2 failed:",e.message)}console.log("Method 3: Attempting Business Manager access...");try{let t=await p(e);if(t.length>0)for(let e of(console.log(`âœ… Method 3: Found ${t.length} Business Manager pages`),t)){let t=o.findIndex(o=>o.id===e.id);t>=0?(o[t]={...o[t],...e},console.log(`âœ… Updated existing page with business info: ${e.name}`)):(o.push(e),console.log(`âœ… Added Business Manager page: ${e.name}`))}else console.log("â„¹ï¸  Method 3: No Business Manager pages found (normal for regular users)")}catch(e){console.log("â„¹ï¸  Method 3: Business Manager access not available (normal for regular users)")}console.log("Method 4: Checking for additional accessible pages...");try{let t=await fetch(`https://graph.facebook.com/v18.0/me?fields=id,name&access_token=${e}`),s=await t.json();if(!s.error){console.log(`âœ… User info: ${s.name} (${s.id})`);let t=await f(e,o);t.length>0&&(console.log(`âœ… Method 4: Found ${t.length} additional pages via Instagram discovery`),o=o.concat(t))}}catch(e){console.error("âŒ Method 4 failed:",e.message)}return console.log(`ðŸ“Š Enhanced discovery complete: ${o.length} total pages found`),o}async function f(e,o){let t=[];try{for(let s of o.slice(0,5))try{let o=await fetch(`https://graph.facebook.com/v18.0/${s.id}?fields=instagram_business_account,connected_instagram_account&access_token=${e}`),a=await o.json();if(a.instagram_business_account||a.connected_instagram_account)for(let o of(console.log(`ðŸ“± Page ${s.name} has Instagram accounts`),await _(e,s.id)))0>t.findIndex(e=>e.id===o.id)&&t.push(o)}catch(e){console.log(`âš ï¸  Error checking Instagram for page ${s.name}:`,e)}}catch(e){console.error("âŒ Instagram discovery failed:",e)}return t}async function _(e,o){let t=[];try{let s=await fetch(`https://graph.facebook.com/v18.0/${o}?fields=connected_pages&access_token=${e}`),a=await s.json();if(!a.error&&a.connected_pages&&a.connected_pages.data)for(let o of a.connected_pages.data)try{let s=await fetch(`https://graph.facebook.com/v18.0/${o.id}?fields=id,name,category&access_token=${e}`),a=await s.json();a.error||t.push({id:a.id,name:a.name,category:a.category,tasks:["MODERATE","MESSAGING","ANALYZE","ADVERTISE","CREATE_CONTENT","MANAGE"],access_token:e,discovered_via:"connected_pages"})}catch(e){}}catch(e){console.log("â„¹ï¸  Related pages discovery not available")}return t}async function $(e){let{searchParams:o}=new URL(e.url),t=o.get("code"),s=o.get("error");if(console.log("OAuth callback received:",{code:t?"present":"missing",error:s}),s)return console.error("OAuth error:",s),c.NextResponse.redirect(`${d(e)}/settings?error=oauth_error&details=${s}`);if(t)try{console.log("Processing OAuth code...");let o=e.headers.get("host")||"",s=o.includes("localhost")||o.includes("127.0.0.1")?"http://localhost:3000/api/meta/oauth":process.env.META_REDIRECT_URI||"https://www.quely.ai/api/meta/oauth",a=await fetch("https://graph.facebook.com/v18.0/oauth/access_token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:l,client_secret:g,redirect_uri:s,code:t})}),n=await a.json();if(console.log("Token exchange response:",n),n.error)return console.error("Token exchange error details:",n.error),c.NextResponse.redirect(`${d(e)}/settings?error=token_exchange_failed&details=${encodeURIComponent(JSON.stringify(n.error))}`);let r=n.access_token;console.log("Short-lived token obtained:",r.substring(0,20)+"..."),console.log("=== STEP 2: EXCHANGING FOR LONG-LIVED TOKEN ===");let p=await fetch(`https://graph.facebook.com/v18.0/oauth/access_token?grant_type=fb_exchange_token&client_id=${l}&client_secret=${g}&fb_exchange_token=${r}`),f=await p.json();if(f.error)return console.error("âŒ Long-lived token exchange failed:",f.error),c.NextResponse.redirect(`${d(e)}/settings?error=token_exchange_failed&details=${encodeURIComponent(JSON.stringify(f.error))}`);let _=f.access_token;console.log("âœ… Long-lived token obtained:",_.substring(0,20)+"..."),console.log("Token expires in:",f.expires_in,"seconds");let $=await fetch(`https://graph.facebook.com/v18.0/me?access_token=${_}`),k=await $.json();if(console.log("User data:",k),k.error)return console.error("User info error:",k.error),c.NextResponse.redirect(`${d(e)}/settings?error=user_info_failed`);console.log("=== STEP 3: COMPREHENSIVE PAGE DISCOVERY ==="),console.log("Using enhanced page discovery for all user types...");let y=[];try{let e=await m(_);y=y.concat(e),console.log(`âœ… Enhanced discovery: Found ${e.length} total pages`)}catch(e){console.error("âŒ Enhanced discovery failed:",e.message);try{let e=await u(_);y=y.concat(e),console.log(`âœ… Fallback discovery: Found ${e.length} basic pages`)}catch(e){console.error("âŒ Fallback discovery also failed:",e.message)}}if(console.log(`
=== PAGE DISCOVERY COMPLETE ===`),console.log(`ðŸ“Š Total unique pages found: ${y.length}`),console.log("All pages found:",y.map(e=>`${e.name} (${e.id})`)),0===y.length)return console.error("âŒ CRITICAL ERROR: No pages found"),c.NextResponse.redirect(`${d(e)}/settings?error=no_pages_found`);let v=y.some(e=>"business_manager"===e.discovered_via||e.business_id),w=y.some(e=>!e.discovered_via||"direct"===e.discovered_via),E=y.some(e=>"connected_pages"===e.discovered_via);console.log(`ðŸ“Š Discovery Analysis:`),console.log(`   - Direct pages: ${w}`),console.log(`   - Business Manager pages: ${v}`),console.log(`   - Connected pages: ${E}`);let b=v?"developer":"regular";console.log(`ðŸ‘¤ User type detected: ${b}`),"regular"===b&&y.length<5&&(console.log(`â„¹ï¸  Regular user with limited pages - this is normal`),console.log(`â„¹ï¸  Business Manager pages may not be visible to regular users`)),console.log("\n=== STEP 4: INSTAGRAM ACCOUNT DISCOVERY ===");let A=await Promise.all(y.map(async(e,o)=>{console.log(`
--- PROCESSING PAGE ${o+1}/${y.length} ---`),console.log(`Page: ${e.name} (ID: ${e.id})`);let t=e.access_token||_;if(console.log(`Original page access token for ${e.name}: ${t.substring(0,20)}...`),e.access_token&&e.access_token!==_)try{console.log(`Exchanging short-lived token for long-lived token for ${e.name}...`);let o=await fetch(`https://graph.facebook.com/v18.0/oauth/access_token?grant_type=fb_exchange_token&client_id=${l}&client_secret=${g}&fb_exchange_token=${e.access_token}`),s=await o.json();!s.error&&s.access_token?(t=s.access_token,console.log(`âœ… Successfully exchanged token for ${e.name}`)):console.log(`âš ï¸  Token exchange failed for ${e.name}, using original token`)}catch(o){console.log(`âš ï¸  Token exchange error for ${e.name}:`,o)}console.log(`Final access token for ${e.name}: ${t.substring(0,20)}...`);let s=await h(e.id,t);return{...e,access_token:t,instagram_accounts:s}}));console.log(`
=== INSTAGRAM DISCOVERY COMPLETE ===`),console.log(`ðŸ“Š Total pages with Instagram: ${A.length}`),A.forEach((e,o)=>{console.log(`${o+1}. ${e.name}: ${e.instagram_accounts.length} Instagram accounts`)});let I=[];for(let e of(console.log("\n=== CREATING CONNECTED ACCOUNTS ==="),A))if(console.log(`Processing page: ${e.name} (${e.id})`),console.log(`Instagram accounts: ${e.instagram_accounts?.length||0}`),e.instagram_accounts&&e.instagram_accounts.length>0)for(let o of e.instagram_accounts)I.push({pageId:e.id,instagramId:o.id}),console.log(`âœ… Connected: ${e.name} â†’ ${o.username}`);else console.log(`â„¹ï¸  No Instagram accounts for ${e.name} - page will still be stored`);console.log(`
=== FINAL SUMMARY ===`),console.log(`ðŸ“Š Total pages to store: ${A.length}`),console.log(`ðŸ“Š Total connected accounts: ${I.length}`),console.log(`ðŸ“Š Pages with Instagram: ${A.filter(e=>e.instagram_accounts?.length>0).length}`),console.log(`ðŸ“Š Pages without Instagram: ${A.filter(e=>!e.instagram_accounts||0===e.instagram_accounts.length).length}`);let R=await fetch(`${d(e)}/api/auth/session`),x=null;try{let e=await R.json();x=e?.user?.id,console.log("Session data:",e)}catch(e){console.log("Could not get session, will use state parameter")}if(!x){console.log("No current user ID found, storing data temporarily");let o={accessToken:_,userId:k.id,pages:A,connected:[]},t=encodeURIComponent(JSON.stringify(o)),s=`${d(e)}/settings?meta_connected=true&data=${t}`;return console.log("Redirecting with data to:",s),c.NextResponse.redirect(s)}console.log("Storing data in database for user:",x);let{data:N}=await i.from("user_profiles").select("id").eq("user_id",x).single();if(N){let{data:o}=await i.from("user_profiles").select("meta_credentials").eq("user_id",x).single(),t=o?.meta_credentials?.connected||[],{error:s}=await i.from("user_profiles").update({meta_credentials:{accessToken:_,pages:A,connected:t}}).eq("user_id",x);if(s)return console.error("Error updating Meta credentials:",s),c.NextResponse.redirect(`${d(e)}/settings?error=save_failed`)}else{let{error:o}=await i.from("user_profiles").insert({user_id:x,meta_credentials:{accessToken:_,pages:A,connected:[]}});if(o)return console.error("Error creating user profile:",o),c.NextResponse.redirect(`${d(e)}/settings?error=save_failed`)}let T=`${d(e)}/settings?meta_connected=true`;return console.log("Redirecting to:",T),c.NextResponse.redirect(T)}catch(o){return console.error("OAuth callback error:",o),c.NextResponse.redirect(`${d(e)}/settings?error=oauth_failed`)}console.log("Starting OAuth flow...");let a=e.headers.get("host")||"",n=a.includes("localhost")||a.includes("127.0.0.1"),r=n?"http://localhost:3000/api/meta/oauth":process.env.META_REDIRECT_URI||"https://www.quely.ai/api/meta/oauth",p="pages_manage_posts,pages_read_engagement,pages_show_list,pages_read_user_content,pages_manage_metadata,instagram_basic,instagram_content_publish,business_management,pages_manage_ads,pages_manage_engagement,pages_manage_cta,pages_manage_instant_articles,pages_utility_messaging,pages_messaging",f=Math.random().toString(36).substring(7);console.log("OAuth parameters:",{redirectUri:r,scope:p,oauthState:f,isLocalhost:n});let _=`https://www.facebook.com/v18.0/dialog/oauth?client_id=${l}&redirect_uri=${encodeURIComponent(r)}&scope=${encodeURIComponent(p)}&state=${f}&auth_type=reauthenticate&response_type=code`;return console.log("Redirecting to Facebook OAuth:",_),c.NextResponse.redirect(_)}let k=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/meta/oauth/route",pathname:"/api/meta/oauth",filename:"route",bundlePath:"app/api/meta/oauth/route"},resolvedPagePath:"/Users/thanveerulaklam/Desktop/Projects/Somema/somema-ai/app/api/meta/oauth/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:y,workUnitAsyncStorage:v,serverHooks:w}=k;function E(){return(0,r.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:v})}},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var o=require("../../../../webpack-runtime.js");o.C(e);var t=e=>o(o.s=e),s=o.X(0,[4447,580,6437],()=>t(12502));module.exports=s})();