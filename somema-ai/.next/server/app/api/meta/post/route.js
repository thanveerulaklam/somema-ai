"use strict";(()=>{var e={};e.id=3966,e.ids=[3966],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{e.exports=require("punycode")},12412:e=>{e.exports=require("assert")},21820:e=>{e.exports=require("os")},25573:(e,s,t)=>{t.r(s),t.d(s,{patchFetch:()=>b,routeModule:()=>p,serverHooks:()=>k,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>f});var o={};t.r(o),t.d(o,{POST:()=>g});var r=t(96559),a=t(48088),n=t(37719),i=t(32190),c=t(66437),l=t(33900),u=t(54731);let d=(0,c.UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function g(e){try{let s,t,o,r=await e.json(),{caption:a,hashtags:n,mediaUrl:c,mediaUrls:g,scheduledTime:p,platform:m,postId:f,selectedPageId:k}=r;if(console.log("Meta post API received data:",r),console.log("Media URLs:",g),console.log("Single media URL:",c),console.log("Platform:",m),console.log("Selected Page ID:",k),!a||!m||!k)return i.NextResponse.json({error:"Missing required fields: caption, platform, and selectedPageId"},{status:400});let b=e.headers.get("authorization");if(!b)return i.NextResponse.json({error:"Authorization header required"},{status:401});let h=b.replace("Bearer ","");console.log("Extracted userId from auth header:",h),console.log("Looking for user profile with userId:",h);let{data:I,error:x}=await d.from("user_profiles").select("user_id, meta_credentials").limit(10);console.log("All user profiles:",I),console.log("List error:",x);let{data:_,error:P}=await d.from("user_profiles").select("meta_credentials").eq("user_id",h).single();if(console.log("Profile query result:",{userProfile:_,profileError:P}),P)return console.error("Profile query error:",P),i.NextResponse.json({error:`Database error: ${P.message}`},{status:400});if(!_?.meta_credentials)return console.log("No meta_credentials found in user profile"),i.NextResponse.json({error:"Meta credentials not found. Please connect your Meta account first."},{status:400});let y=_.meta_credentials;console.log("Full credentials structure:",JSON.stringify(y,null,2));let q=y.pages?.find(e=>e.id===k);if(!q)return console.log("Available pages:",y.pages),i.NextResponse.json({error:"Selected page not found in user credentials"},{status:400});console.log("Selected page structure:",JSON.stringify(q,null,2));let v=q.instagram_accounts?.[0]?.id;v||(q.instagram_accounts&&Array.isArray(q.instagram_accounts)&&(v=q.instagram_accounts[0]?.id),!v&&q.instagram_business_account&&(v=q.instagram_business_account.id||q.instagram_business_account),!v&&q.connected_instagram_account&&(v=q.connected_instagram_account.id||q.connected_instagram_account)),console.log("Selected page:",q.id),console.log("Instagram account ID found:",v),console.log("Instagram accounts array:",q.instagram_accounts),console.log("Full selected page structure:",JSON.stringify(q,null,2));let w=(0,l.b)({accessToken:y.accessToken,pageId:q.id,instagramBusinessAccountId:v});if(!(await w.validateToken()).valid)return i.NextResponse.json({error:"Invalid Meta access token. Please reconnect your account."},{status:400});let F={caption:a,hashtags:n||[],mediaUrl:c,mediaUrls:g||(c?[c]:void 0),scheduledTime:p,platform:m};switch(m){case"instagram":if(v){console.log("Posting to Instagram using Instagram API...");let e=y.pages?.find(e=>e.id===k),t=e?.access_token;if(t){let e=(0,u.w)({accessToken:t,instagramBusinessAccountId:v});s=await e.postToInstagram({caption:F.caption,hashtags:F.hashtags,mediaUrl:F.mediaUrl,mediaUrls:F.mediaUrls,scheduledTime:F.scheduledTime})}else s={success:!1,error:"Page access token not found"}}else s={success:!1,error:"No Instagram business account connected to this page. Please connect an Instagram account first."};break;case"facebook":console.log("Posting to Facebook..."),s=await w.postToFacebook(F);break;case"both":if(console.log("Posting to both platforms (Instagram first)..."),v){console.log("Attempting Instagram post with account ID:",v);try{let e=y.pages?.find(e=>e.id===k),s=e?.access_token;if(s){let e=(0,u.w)({accessToken:s,instagramBusinessAccountId:v});t=await e.postToInstagram({caption:F.caption,hashtags:F.hashtags,mediaUrl:F.mediaUrl,mediaUrls:F.mediaUrls,scheduledTime:F.scheduledTime})}else t={success:!1,error:"Page access token not found"};console.log("Instagram result:",t)}catch(e){console.error("Instagram posting error:",e),t={success:!1,error:e.message||"Failed to post to Instagram"}}}else console.log("No Instagram account ID found, skipping Instagram posting"),t={success:!1,error:"No Instagram business account connected to this page. Please connect an Instagram account first."};console.log("Attempting Facebook post...");try{o=await w.postToFacebook(F),console.log("Facebook result:",o)}catch(e){console.error("Facebook posting error:",e),o={success:!1,error:e.message||"Failed to post to Facebook"}}s={instagram:t,facebook:o};break;default:return i.NextResponse.json({error:"Invalid platform. Must be facebook, instagram, or both"},{status:400})}if(f){let e={updated_at:new Date().toISOString()};if("both"===m){let t=s,o=t.facebook.success,r=t.instagram.success;e.status=o&&r?"scheduled":"failed",e.meta_post_ids={facebook:t.facebook.postId,instagram:t.instagram.postId},o&&r||(e.meta_errors={facebook:t.facebook.error,instagram:t.instagram.error})}else{let t=s;e.status=t.success?"scheduled":"failed",t.success?(e.meta_post_id=t.postId,e.scheduled_for=p):e.meta_error=t.error}await d.from("posts").update(e).eq("id",f).eq("user_id",h)}let A=!0,j="Post published successfully!",R="";if("both"===m){let e=s,t=e.facebook.success,o=e.instagram.success;t&&o?j="Post published successfully to both Instagram and Facebook!":t&&!o?(j="Posted to Facebook successfully, but Instagram posting failed. Please try Instagram posting again in a few minutes.",R=`Instagram error: ${e.instagram.error}`,A=!1):!t&&o?e.facebook.skipped?(j="Posted to Instagram successfully! Facebook posting was skipped due to video file size limits.",A=!0):(j="Posted to Instagram successfully, but Facebook posting failed.",R=`Facebook error: ${e.facebook.error}`,A=!1):(j="Posting failed on both platforms. Please try again in a few minutes.",R=`Instagram: ${e.instagram.error}, Facebook: ${e.facebook.error}`,A=!1)}else{let e=s;e.success||(j="instagram"===m?"Instagram posting failed. This is common with Instagram's API. Please try again in a few minutes.":"Facebook posting failed. Please try again.",R=e.error,A=!1)}return i.NextResponse.json({success:A,result:s,message:j,errorDetails:R||null})}catch(e){return console.error("Meta posting error:",e),i.NextResponse.json({error:e.message||"Failed to post to Meta platforms"},{status:500})}}let p=new r.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/meta/post/route",pathname:"/api/meta/post",filename:"route",bundlePath:"app/api/meta/post/route"},resolvedPagePath:"/Users/thanveerulaklam/Desktop/Projects/Somema/somema-ai/app/api/meta/post/route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:m,workUnitAsyncStorage:f,serverHooks:k}=p;function b(){return(0,n.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:f})}},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var s=require("../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),o=s.X(0,[4447,580,6437,139,7839,5759,4731],()=>t(25573));module.exports=o})();