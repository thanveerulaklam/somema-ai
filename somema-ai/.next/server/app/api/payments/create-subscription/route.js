(()=>{var e={};e.id=2356,e.ids=[2356],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},12412:e=>{"use strict";e.exports=require("assert")},21820:e=>{"use strict";e.exports=require("os")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},50080:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>b,routeModule:()=>_,serverHooks:()=>g,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>m});var s={};t.r(s),t.d(s,{POST:()=>d});var o=t(96559),n=t(48088),i=t(37719),a=t(32190),c=t(95457),l=t.n(c);let p=(0,t(66437).UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),u=new(l())({key_id:process.env.RAZORPAY_KEY_ID,key_secret:process.env.RAZORPAY_KEY_SECRET});async function d(e){try{console.log("\uD83D\uDD04 Subscription creation started");let{planId:r,userId:t,billingCycle:s="monthly",currency:o="INR",isIndianVisitor:n=!1}=await e.json();if(console.log("\uD83D\uDCCB Request data:",{planId:r,userId:t,billingCycle:s,currency:o,isIndianVisitor:n}),!r||!t)return console.error("❌ Missing required fields:",{planId:r,userId:t}),a.NextResponse.json({error:"Missing required fields"},{status:400});if(!process.env.RAZORPAY_KEY_ID||!process.env.RAZORPAY_KEY_SECRET)return console.error("❌ Razorpay credentials not configured"),a.NextResponse.json({error:"Payment service not configured"},{status:500});console.log("✅ Razorpay credentials found");let i={starter:{name:"Starter Plan",priceINR:{monthly:999,yearly:9990},priceUSD:{monthly:29,yearly:290},plan_id_monthly:"plan_starter_monthly",plan_id_yearly:"plan_starter_yearly"},growth:{name:"Growth Plan",priceINR:{monthly:2499,yearly:24990},priceUSD:{monthly:79,yearly:790},plan_id_monthly:"plan_growth_monthly",plan_id_yearly:"plan_growth_yearly"},scale:{name:"Scale Plan",priceINR:{monthly:8999,yearly:89990},priceUSD:{monthly:199,yearly:1990},plan_id_monthly:"plan_scale_monthly",plan_id_yearly:"plan_scale_yearly"}}[r];if(!i)return console.error("❌ Invalid plan ID:",r),a.NextResponse.json({error:"Invalid plan ID"},{status:400});let c=n?i.priceINR[s]:i.priceUSD[s],l=100*c,d=0,_=l;n?(d=Math.round(.18*l),_=l+d,console.log("\uD83C\uDDEE\uD83C\uDDF3 Indian user detected - GST will be applied")):(d=0,_=l,console.log("\uD83C\uDF0D International user detected - no GST (export of services)")),console.log("\uD83D\uDCB0 Creating Razorpay subscription with amount:",_,"currency:",o),console.log("\uD83D\uDCCA Tax calculation:",{baseAmount:c,orderAmount:l,taxAmount:d,totalAmount:_,currency:o,isIndianVisitor:n});let{data:y,error:m}=await p.from("user_profiles").select("user_id, full_name, business_name").eq("user_id",t).single();if(m||!y)return console.error("❌ Error fetching user data:",m),a.NextResponse.json({error:"User not found"},{status:404});let g={plan_id:`plan_${r}_${s}`,customer_notify:!0,quantity:1,total_count:12,start_at:Math.floor(Date.now()/1e3)+300,expire_by:Math.floor(Date.now()/1e3)+("yearly"===s?31536e3:2592e3),addons:[],notes:{plan_id:r,billing_cycle:s,user_id:t,business_name:y.full_name||y.business_name||"Customer"}};console.log("\uD83D\uDCCB Creating Razorpay subscription with data:",g);let b=`plan_${r}_${s}`;console.log("\uD83D\uDCCB Using plan ID:",b);try{let e={...g,plan_id:b},n=await u.subscriptions.create(e);console.log("✅ Razorpay subscription created with pre-created plan:",n.id),console.log("\uD83D\uDCDD Subscription record will be created after payment verification");let{error:i}=await p.from("user_profiles").upsert({user_id:t,subscription_plan:r,subscription_status:"pending",razorpay_subscription_id:n.id,subscription_start_date:new Date().toISOString(),subscription_end_date:new Date(Date.now()+("yearly"===s?31536e6:2592e6)).toISOString(),billing_cycle:s,updated_at:new Date().toISOString()},{onConflict:"user_id"});return i&&console.error("❌ Error updating user profile:",i),console.log("\uD83C\uDF89 Subscription creation completed successfully"),a.NextResponse.json({success:!0,message:"Subscription created successfully",subscriptionId:n.id,amount:_,currency:o,billingCycle:s,short_url:n.short_url,redirect_urls:{success:`${process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000"}/payment-success`,failure:`${process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000"}/pricing?subscription=failed`}})}catch(e){if(!(e.error?.code==="BAD_REQUEST_ERROR"&&e.error?.description?.includes("does not exist")))return console.error("❌ Unexpected subscription creation error:",e),a.NextResponse.json({error:"Failed to create subscription",details:e.error?.description||"Unknown error"},{status:500});{console.log("\uD83D\uDCCB Plan does not exist, creating it dynamically...");let e={period:"yearly"===s?"yearly":"monthly",interval:1,item:{name:i.name,description:`${i.name} - ${s} subscription`,amount:_,currency:o},notes:{plan_id:r,billing_cycle:s}};try{let n=await u.plans.create(e);console.log("✅ Razorpay plan created dynamically:",n.id);let i={...g,plan_id:n.id},c=await u.subscriptions.create(i);console.log("✅ Razorpay subscription created with dynamic plan:",c.id),console.log("\uD83D\uDCDD Subscription record will be created after payment verification");let{error:l}=await p.from("user_profiles").upsert({user_id:t,subscription_plan:r,subscription_status:"pending",razorpay_subscription_id:c.id,subscription_start_date:new Date().toISOString(),subscription_end_date:new Date(Date.now()+("yearly"===s?31536e6:2592e6)).toISOString(),billing_cycle:s,updated_at:new Date().toISOString()},{onConflict:"user_id"});return l&&console.error("❌ Error updating user profile:",l),console.log("\uD83C\uDF89 Subscription creation completed successfully with dynamic plan"),a.NextResponse.json({success:!0,message:"Subscription created successfully",subscriptionId:c.id,amount:_,currency:o,billingCycle:s,short_url:c.short_url,redirect_urls:{success:`${process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000"}/payment-success`,failure:`${process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000"}/pricing?subscription=failed`}})}catch(e){return console.error("❌ Error creating plan:",e),a.NextResponse.json({error:"Failed to create subscription plan",details:e.error?.description||"Unknown error"},{status:500})}}}}catch(e){return console.error("❌ Subscription creation error:",e),a.NextResponse.json({error:"Failed to create subscription",details:e.message||"Unknown error"},{status:500})}}let _=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/payments/create-subscription/route",pathname:"/api/payments/create-subscription",filename:"route",bundlePath:"app/api/payments/create-subscription/route"},resolvedPagePath:"/Users/thanveerulaklam/Desktop/Projects/Somema/somema-ai/app/api/payments/create-subscription/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:y,workUnitAsyncStorage:m,serverHooks:g}=_;function b(){return(0,i.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:m})}},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},83997:e=>{"use strict";e.exports=require("tty")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4447,580,6437,139,5457],()=>t(50080));module.exports=s})();