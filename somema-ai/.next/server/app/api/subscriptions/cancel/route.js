(()=>{var e={};e.id=1769,e.ids=[1769],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10481:(e,r,s)=>{"use strict";s.r(r),s.d(r,{patchFetch:()=>m,routeModule:()=>x,serverHooks:()=>f,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>_});var t={};s.r(t),s.d(t,{POST:()=>b});var o=s(96559),i=s(48088),n=s(37719),a=s(32190),u=s(66437),c=s(95457),p=s.n(c);let l=(0,u.UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),d=new(p())({key_id:process.env.RAZORPAY_KEY_ID,key_secret:process.env.RAZORPAY_KEY_SECRET});async function b(e){try{console.log("\uD83D\uDEAB Subscription cancellation request received");let{userId:r}=await e.json();if(!r)return a.NextResponse.json({error:"User ID is required"},{status:400});let{data:s,error:t}=await l.from("user_profiles").select("razorpay_subscription_id, subscription_plan, subscription_status").eq("user_id",r).single(),{data:o,error:i}=await l.from("subscriptions").select("razorpay_subscription_id, status").eq("user_id",r).eq("status","active").single();if(t||!s)return console.error("❌ Error fetching user data:",t),a.NextResponse.json({error:"User not found"},{status:404});if("free"===s.subscription_plan)return a.NextResponse.json({error:"No active subscription to cancel"},{status:400});if("cancelled"===s.subscription_status)return a.NextResponse.json({error:"Subscription is already cancelled"},{status:400});console.log("\uD83D\uDCCB Cancelling subscription for user:",r),console.log("Current plan:",s.subscription_plan),console.log("Current status:",s.subscription_status);let n=s.razorpay_subscription_id||o?.razorpay_subscription_id;if(n){console.log("\uD83D\uDCCB Cancelling Razorpay subscription:",n);try{await d.subscriptions.cancel(n,!1),console.log("✅ Subscription cancelled in Razorpay")}catch(e){console.error("❌ Razorpay cancellation error:",e),e.error?.code==="BAD_REQUEST_ERROR"&&(e.error?.description?.includes("already cancelled")||e.error?.description?.includes("not cancellable")||e.error?.description?.includes("expired"))?console.log("ℹ️ Subscription already cancelled/expired in Razorpay, updating database"):console.log("⚠️ Unexpected Razorpay error, but continuing with database update")}}else console.log("ℹ️ No Razorpay subscription ID found - using one-time payment model");let{error:u}=await l.from("user_profiles").update({subscription_status:"cancelled",subscription_plan:"free",post_generation_credits:15,image_enhancement_credits:3,media_storage_limit:5e7,updated_at:new Date().toISOString()}).eq("user_id",r);if(u)return console.error("❌ Error updating user subscription:",u),a.NextResponse.json({error:"Failed to update subscription status",details:u.message},{status:500});let{error:c}=await l.from("subscriptions").update({status:"cancelled",updated_at:new Date().toISOString()}).eq("user_id",r).eq("status","active");return c&&console.log("⚠️ Could not update subscriptions table:",c.message),console.log("✅ Subscription cancelled successfully for user:",r),a.NextResponse.json({success:!0,message:"Subscription cancelled successfully. You will retain access until the end of your current billing period.",newPlan:"free",creditsReset:{postGenerations:15,imageEnhancements:3}})}catch(e){return console.error("❌ Subscription cancellation error:",e),a.NextResponse.json({error:"Failed to cancel subscription",details:e.message||"Unknown error"},{status:500})}}let x=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/subscriptions/cancel/route",pathname:"/api/subscriptions/cancel",filename:"route",bundlePath:"app/api/subscriptions/cancel/route"},resolvedPagePath:"/Users/thanveerulaklam/Desktop/Projects/Somema/somema-ai/app/api/subscriptions/cancel/route.ts",nextConfigOutput:"",userland:t}),{workAsyncStorage:g,workUnitAsyncStorage:_,serverHooks:f}=x;function m(){return(0,n.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:_})}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},12412:e=>{"use strict";e.exports=require("assert")},21820:e=>{"use strict";e.exports=require("os")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},83997:e=>{"use strict";e.exports=require("tty")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[4447,580,6437,139,5457],()=>s(10481));module.exports=t})();