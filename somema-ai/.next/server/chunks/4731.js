"use strict";exports.id=4731,exports.ids=[4731],exports.modules={54731:(e,o,r)=>{r.d(o,{w:()=>l});var t=r(66437);let s={MIN:.5625,MAX:1.91};async function i(e){try{let o=await fetch(e);if(!o.ok)return{isValid:!1,error:"Could not fetch image"};let r=await o.arrayBuffer(),t=Buffer.from(r),i=0,a=0;if(255===t[0]&&216===t[1]){let e=2;for(;e<t.length-9;)if(255===t[e]){let o=t[e+1];if([192,193,194,195,197,198,199,201,202,203,205,206,207].includes(o)){a=t.readUInt16BE(e+5),i=t.readUInt16BE(e+7);break}e+=2}else e++}else 137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]?(i=t.readUInt32BE(16),a=t.readUInt32BE(20)):71===t[0]&&73===t[1]&&70===t[2]?(i=t.readUInt16LE(6),a=t.readUInt16LE(8)):82===t[0]&&73===t[1]&&70===t[2]&&87===t[8]&&69===t[9]&&66===t[10]&&80===t[11]&&(i=t.readUInt16LE(26)+1,a=t.readUInt16LE(28)+1);if(0===i||0===a)return console.log(`Could not determine dimensions for ${e}, assuming valid for Instagram`),{isValid:!0,width:1080,height:1080,aspectRatio:1,needsResize:!1};let n=i/a,l=n>=s.MIN&&n<=s.MAX;return{isValid:l,width:i,height:a,aspectRatio:n,needsResize:!l,error:l?void 0:`Aspect ratio ${n.toFixed(2)} is not supported. Instagram requires aspect ratio between ${s.MIN} and ${s.MAX}`}}catch(o){return console.error(`Error validating image ${e}:`,o),{isValid:!0,width:1080,height:1080,aspectRatio:1,needsResize:!1}}}async function a(e){try{let o=process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000",r=await fetch(`${o}/api/resize-image`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({imageUrl:e})}),t=await r.json();if(!r.ok)return{success:!1,error:t.error||"Failed to resize image"};if(t.resized&&t.resizedUrl)return{success:!0,resizedUrl:t.resizedUrl};return{success:!0,resizedUrl:e}}catch(e){return{success:!1,error:`Error resizing image: ${e}`}}}class n{constructor(e){this.baseUrl="https://graph.instagram.com/v12.0",this.accessToken=e.accessToken,this.instagramBusinessAccountId=e.instagramBusinessAccountId,this.supabase=(0,t.UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY)}async validateAndConvertMediaUrl(e){if(!e||e.startsWith("http")&&!e.startsWith("data:"))return e;if(e.startsWith("data:")){console.log("Converting data URL to public URL for Instagram...");try{let o=await fetch(e),r=await o.blob(),t=r.type.includes("video")?"mp4":"jpg",s=`${Date.now()}-${Math.random().toString(36).substring(7)}.${t}`,i=`media/converted/${s}`,{error:a}=await this.supabase.storage.from("media").upload(i,r);if(a)throw console.error("Failed to upload converted media for Instagram:",a),Error("Failed to convert data URL to public URL");let{data:{publicUrl:n}}=this.supabase.storage.from("media").getPublicUrl(i);return console.log("Data URL converted to public URL for Instagram:",n),n}catch(e){throw console.error("Error converting data URL for Instagram:",e),Error("Failed to convert data URL to public URL")}}if(e.startsWith("blob:"))throw Error("Blob URLs are not supported in server-side posting. Please use public URLs.");return e}async validatePostContent(e){let o={...e};if(e.mediaUrl&&(o.mediaUrl=await this.validateAndConvertMediaUrl(e.mediaUrl)),e.mediaUrls&&e.mediaUrls.length>0){let r=[];for(let o of e.mediaUrls){let e=await this.validateAndConvertMediaUrl(o);r.push(e)}o.mediaUrls=r}return o}async postToInstagram(e){try{console.log("=== INSTAGRAM API POSTING START ==="),console.log("Original content:",e);let o=await this.validatePostContent(e);console.log("Validated content:",o),console.log("Instagram Business Account ID:",this.instagramBusinessAccountId);let r=o.mediaUrls&&o.mediaUrls.length>0?o.mediaUrls:o.mediaUrl?[o.mediaUrl]:[];if(0===r.length)throw Error("No media URL provided");let t=await Promise.all(r.map(async e=>{let o=await i(e);return{url:e,validation:o}})),s=await Promise.all(t.map(async e=>{if(e.validation.needsResize){console.log(`Resizing image: ${e.url} (aspect ratio: ${e.validation.aspectRatio?.toFixed(2)})`);let o=await a(e.url);if(o.success&&o.resizedUrl)return o.resizedUrl;throw Error(`Failed to resize image ${e.url}: ${o.error}`)}return e.url})),n=t.filter(e=>!e.validation.isValid&&!e.validation.needsResize);n.length>0&&console.warn("Some images failed validation, but proceeding anyway:",n.map(e=>e.url)),console.log("Image validation results:"),t.forEach(e=>{console.log(`${e.url}: ${e.validation.width}x${e.validation.height} (aspect ratio: ${e.validation.aspectRatio?.toFixed(2)})`)});let l=this.formatCaption(o.caption,o.hashtags);if(r.length<=1){let e=s[0];if(!e)throw Error("No media URL provided");let r=e.match(/\.(mp4|mov|webm|avi|mkv)$/i),t={media_type:r?"REELS":"IMAGE",[r?"video_url":"image_url"]:e,caption:l,access_token:this.accessToken};o.scheduledTime&&(console.log("Adding scheduling to Instagram post..."),t.published=!1,t.scheduled_publish_time=Math.floor(new Date(o.scheduledTime).getTime()/1e3),console.log("Scheduled publish time:",t.scheduled_publish_time)),console.log("Creating single media post..."),console.log("Video URL:",e),console.log("Media data:",t);try{let o=await fetch(e,{method:"HEAD"});if(!o.ok)throw Error(`Video URL not accessible: ${o.status} ${o.statusText}`);console.log("Video URL is accessible")}catch(e){throw console.error("Error checking video URL:",e),Error(`Video URL check failed: ${e.message||"Unknown error"}`)}let i=await fetch(`https://graph.facebook.com/v18.0/${this.instagramBusinessAccountId}/media`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),a=await i.json();if(console.log("Single media response:",a),!i.ok)throw console.error("Instagram API error response:",a),Error(`Instagram API error: ${a.error?.message||a.error?.type||"Unknown error"}`);console.log("Polling for media status before publishing...");let n="IN_PROGRESS",c=0;for(;"FINISHED"!==n&&c<30;){c++,console.log(`Checking media status (poll ${c}/30)...`);let e=await fetch(`https://graph.facebook.com/v18.0/${a.id}?fields=status_code&access_token=${this.accessToken}`);if(!e.ok)throw console.error("Error checking media status:",await e.text()),Error("Failed to check media status");let o=await e.json();if(n=o.status_code,console.log("Media status:",n),"FINISHED"===n){console.log("Media processing finished! Ready to publish.");break}if("ERROR"===n)throw console.error("Media processing failed:",o),Error(`Media processing failed: ${o.error?.message||"Unknown error"}`);c<30&&(console.log("Media still processing, waiting 10000ms before next check..."),await new Promise(e=>setTimeout(e,1e4)))}if("FINISHED"!==n)throw Error("Media processing timed out after 5 minutes");if(o.scheduledTime)return console.log("Post is scheduled - Instagram will handle publishing at the scheduled time"),console.log("=== INSTAGRAM SCHEDULED POSTING SUCCESS ==="),{success:!0,postId:a.id,scheduledTime:o.scheduledTime};console.log("Attempting to publish media..."),console.log("Publishing media...");let d={creation_id:a.id,access_token:this.accessToken},h=await fetch(`https://graph.facebook.com/v18.0/${this.instagramBusinessAccountId}/media_publish`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)}),u=await h.json();if(console.log("Publish response:",u),!h.ok)throw Error(`Instagram publish error: ${u.error?.message||"Unknown error"}`);return console.log("=== INSTAGRAM API POSTING SUCCESS ==="),{success:!0,postId:u.id,scheduledTime:void 0}}if(r.length>1){if(r.length>10)throw Error("Carousel posts are limited to 10 images/videos maximum");console.log("Creating carousel post with",r.length,"images...");let e=[];for(let o of s){console.log("Processing media URL for Instagram:",o);let r=o.match(/\.(mp4|mov|webm|avi|mkv)$/i),t={media_type:r?"REELS":"IMAGE",[r?"video_url":"image_url"]:o,access_token:this.accessToken};try{let r=await fetch(`https://graph.facebook.com/v18.0/${this.instagramBusinessAccountId}/media`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),s=await r.json();if(console.log("Individual media response:",s),!r.ok)throw console.error("Error with media",o+":",s),Error(`Failed to create media container: ${s.error?.message||"Unknown error"}`);e.push(s.id)}catch(e){throw console.error("Error creating individual media container:",e),e}}if(0===e.length)throw Error("No valid media containers created for carousel");let t={media_type:"CAROUSEL",children:e.join(","),caption:l,access_token:this.accessToken};o.scheduledTime&&(console.log("Adding scheduling to carousel post..."),t.published=!1,t.scheduled_publish_time=Math.floor(new Date(o.scheduledTime).getTime()/1e3),console.log("Scheduled publish time:",t.scheduled_publish_time));let i=await fetch(`https://graph.facebook.com/v18.0/${this.instagramBusinessAccountId}/media`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),a=await i.json();if(console.log("Carousel response:",a),!i.ok)throw Error(`Carousel creation failed: ${a.error?.message||"Unknown error"}`);if(o.scheduledTime)return console.log("Carousel post is scheduled - Instagram will handle publishing at the scheduled time"),console.log("=== INSTAGRAM SCHEDULED CAROUSEL POSTING SUCCESS ==="),{success:!0,postId:a.id,scheduledTime:o.scheduledTime};let n={creation_id:a.id,access_token:this.accessToken},c=await fetch(`https://graph.facebook.com/v18.0/${this.instagramBusinessAccountId}/media_publish`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),d=await c.json();if(console.log("Carousel publish response:",d),!c.ok)throw Error(`Carousel publish failed: ${d.error?.message||"Unknown error"}`);return console.log("=== INSTAGRAM API POSTING SUCCESS ==="),{success:!0,postId:d.id,scheduledTime:void 0}}throw Error("No valid media content provided")}catch(e){return console.error("=== INSTAGRAM API POSTING ERROR ==="),console.error("Error:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async getAccountInfo(){try{let e=await fetch(`${this.baseUrl}/me?fields=id,username,name,profile_picture_url,followers_count,media_count&access_token=${this.accessToken}`),o=await e.json();if(o.error)throw Error(o.error.message);return{id:o.id,username:o.username,name:o.name,profilePictureUrl:o.profile_picture_url,followersCount:o.followers_count,mediaCount:o.media_count}}catch(e){throw console.error("Error getting Instagram account info:",e),e}}async getRecentMedia(e=10){try{let o=await fetch(`${this.baseUrl}/me/media?fields=id,caption,media_type,media_url,thumbnail_url,permalink,timestamp&limit=${e}&access_token=${this.accessToken}`),r=await o.json();if(r.error)throw Error(r.error.message);return r.data||[]}catch(e){throw console.error("Error getting Instagram recent media:",e),e}}async validateToken(){try{let e=await this.getAccountInfo();return{valid:!0,account:e}}catch(e){return{valid:!1,error:e.message}}}formatCaption(e,o){let r=e||"";if(o&&o.length>0){let e=o.map(e=>`#${e.replace("#","")}`).join(" ");r+=`

${e}`}return r}}function l(e){return new n(e)}}};