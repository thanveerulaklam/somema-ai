exports.id=5759,exports.ids=[5759],exports.modules={33900:(e,o,s)=>{"use strict";s.d(o,{b:()=>n});var t=s(77839),a=s(66437);class r{constructor(e){this.accessToken=e.accessToken,this.pageId=e.pageId,this.instagramBusinessAccountId=e.instagramBusinessAccountId,this.appId=process.env.META_APP_ID||"",this.appSecret=process.env.META_APP_SECRET||"",t.ZFN.init(this.accessToken),this.supabase=(0,a.UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY)}async validateAndConvertMediaUrl(e){if(!e||e.startsWith("http")&&!e.startsWith("data:"))return e;if(e.startsWith("data:")){console.log("Converting data URL to public URL...");try{let o=await fetch(e),s=await o.blob(),t=s.type.includes("video")?"mp4":"jpg",a=`${Date.now()}-${Math.random().toString(36).substring(7)}.${t}`,r=`media/converted/${a}`,{error:n}=await this.supabase.storage.from("media").upload(r,s);if(n)throw console.error("Failed to upload converted media:",n),Error("Failed to convert data URL to public URL");let{data:{publicUrl:i}}=this.supabase.storage.from("media").getPublicUrl(r);return console.log("Data URL converted to public URL:",i),i}catch(e){throw console.error("Error converting data URL:",e),Error("Failed to convert data URL to public URL")}}if(e.startsWith("blob:"))throw Error("Blob URLs are not supported in server-side posting. Please use public URLs.");return e}async validatePostContent(e){let o={...e};if(e.mediaUrl&&(o.mediaUrl=await this.validateAndConvertMediaUrl(e.mediaUrl)),e.mediaUrls&&e.mediaUrls.length>0){let s=[];for(let o of e.mediaUrls){let e=await this.validateAndConvertMediaUrl(o);s.push(e)}o.mediaUrls=s}return o}async postToFacebook(e){try{if(!this.pageId)throw Error("Facebook Page ID is required");let o=await this.validatePostContent(e);console.log("Validated Facebook post content:",o);let s=await fetch(`https://graph.facebook.com/v18.0/me/accounts?access_token=${this.accessToken}`),t=await s.json();if(t.error)throw Error(t.error.message);let a=t.data?.find(e=>e.id===this.pageId);if(!a)throw Error("Selected page not found");let r=a.access_token,n={message:this.formatMessage(o.caption,o.hashtags),access_token:r};if(o.mediaUrls&&o.mediaUrls.length>1){let s=[];for(let e of o.mediaUrls)if(/\.(mp4|mov|avi|wmv|flv|webm|mkv)$/i.test(e)){let t={file_url:e,description:this.formatMessage(o.caption,o.hashtags),access_token:r},a=await fetch(`https://graph.facebook.com/v18.0/${this.pageId}/videos`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),n=await a.json();if(n.error)throw Error(JSON.stringify(n.error));s.push(n.id)}else{let o={url:e,published:!1,access_token:r},t=await fetch(`https://graph.facebook.com/v18.0/${this.pageId}/photos`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),a=await t.json();if(a.error)throw Error(JSON.stringify(a.error));s.push(a.id)}if(0===s.length)throw Error("No valid media created for Facebook carousel");let t=s.map(e=>({media_fbid:e})),a={message:this.formatMessage(e.caption,e.hashtags),attached_media:t,access_token:r},n=await fetch(`https://graph.facebook.com/v18.0/${this.pageId}/feed`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),i=await n.json();if(i.error)throw Error(JSON.stringify(i.error));return{success:!0,postId:i.id,scheduledTime:o.scheduledTime}}if(o.mediaUrl){let e=o.mediaUrl;if(/\.(mp4|mov|avi|wmv|flv|webm|mkv)$/i.test(e)){try{let o=(await fetch(e,{method:"HEAD"})).headers.get("content-length");if(o&&parseInt(o)>0x1900000)return console.warn(`Video file too large for Facebook API (${Math.round(parseInt(o)/1024/1024)}MB), skipping Facebook post`),{success:!1,error:"Video file too large for Facebook API (Instagram post successful)",skipped:!0}}catch(e){console.warn("Could not check video file size, proceeding with Facebook post attempt")}let s={file_url:e,description:this.formatMessage(o.caption,o.hashtags),access_token:r};console.log("Facebook video post payload:",JSON.stringify(s,null,2));let t=await fetch(`https://graph.facebook.com/v18.0/${this.pageId}/videos`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),a=await t.json();if(console.log("Facebook video post response:",JSON.stringify(a,null,2)),a.error){if(console.error("Facebook video post error:",JSON.stringify(a.error,null,2)),1===a.error.code&&a.error.message.includes("reduce the amount of data"))return console.warn("Facebook video file too large, skipping Facebook post but keeping Instagram post"),{success:!1,error:"Video file too large for Facebook API (Instagram post successful)",skipped:!0};throw Error(JSON.stringify(a.error))}return{success:!0,postId:a.id,scheduledTime:o.scheduledTime}}{let s={url:e,message:this.formatMessage(o.caption,o.hashtags),access_token:r};console.log("Facebook photo post payload:",JSON.stringify(s,null,2));let t=await fetch(`https://graph.facebook.com/v18.0/${this.pageId}/photos`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),a=await t.json();if(console.log("Facebook photo post response:",JSON.stringify(a,null,2)),a.error)throw console.error("Facebook photo post error:",JSON.stringify(a.error,null,2)),Error(JSON.stringify(a.error));return{success:!0,postId:a.id,scheduledTime:o.scheduledTime}}}{console.log("Facebook feed post payload:",JSON.stringify(n,null,2));let o=await fetch(`https://graph.facebook.com/v18.0/${this.pageId}/feed`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),s=await o.json();if(console.log("Facebook feed post response:",JSON.stringify(s,null,2)),s.error)throw console.error("Facebook feed post error:",JSON.stringify(s.error,null,2)),Error(JSON.stringify(s.error));return{success:!0,postId:s.id,scheduledTime:e.scheduledTime}}}catch(e){return console.error("Facebook posting error:",e),{success:!1,error:e.message||"Failed to post to Facebook"}}}async postToInstagram(e){try{if(console.log("=== INSTAGRAM POSTING START ==="),console.log("Instagram Business Account ID:",this.instagramBusinessAccountId),console.log("Page ID:",this.pageId),console.log("Content:",{caption:e.caption,hashtags:e.hashtags,mediaUrl:e.mediaUrl}),!this.instagramBusinessAccountId)throw Error("Instagram Business Account ID is required");console.log("Fetching page access token...");let o=await fetch(`https://graph.facebook.com/v18.0/me/accounts?access_token=${this.accessToken}`),s=await o.json();if(console.log("Page data response:",JSON.stringify(s,null,2)),s.error)throw console.error("Page data error:",s.error),Error(s.error.message);let t=s.data?.find(e=>e.id===this.pageId);if(console.log("Selected page:",t),!t)throw console.error("Selected page not found. Available pages:",s.data),Error("Selected page not found");let a=t.access_token;console.log("Page access token obtained:",a?"YES":"NO");let r={caption:this.formatMessage(e.caption,e.hashtags),access_token:a};e.mediaUrl&&(console.log("Adding media to post data..."),r.media_type="IMAGE",r.image_url=e.mediaUrl),e.scheduledTime&&(console.log("Adding scheduling to post data..."),r.published=!1,r.scheduled_publish_time=Math.floor(new Date(e.scheduledTime).getTime()/1e3)),console.log("Final post data:",JSON.stringify(r,null,2)),console.log("Making Instagram media API call to:",`https://graph.facebook.com/v18.0/${this.instagramBusinessAccountId}/media`);let n=await fetch(`https://graph.facebook.com/v18.0/${this.instagramBusinessAccountId}/media`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});console.log("Instagram media API response status:",n.status);let i=await n.json();if(console.log("Instagram media API response data:",JSON.stringify(i,null,2)),i.error)throw console.error("Instagram media API error:",i.error),Error(i.error.message);if(i.id){console.log("Media created successfully with ID:",i.id),console.log("Publishing media...");let o=await fetch(`https://graph.facebook.com/v18.0/${this.instagramBusinessAccountId}/media_publish`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({creation_id:i.id,access_token:a})});console.log("Instagram publish API response status:",o.status);let s=await o.json();if(console.log("Instagram publish API response data:",JSON.stringify(s,null,2)),s.error)throw console.error("Instagram publish API error:",s.error),Error(s.error.message);return console.log("=== INSTAGRAM POSTING SUCCESS ==="),{success:!0,postId:s.id,scheduledTime:e.scheduledTime}}return console.log("No media ID returned, treating as text-only post"),{success:!0,postId:i.id,scheduledTime:e.scheduledTime}}catch(e){return console.error("=== INSTAGRAM POSTING ERROR ==="),console.error("Instagram posting error:",e),console.error("Error message:",e.message),console.error("Error stack:",e.stack),{success:!1,error:e.message||"Failed to post to Instagram"}}}async postToBoth(e){let[o,s]=await Promise.all([this.postToFacebook(e),this.postToInstagram(e)]);return{facebook:o,instagram:s}}async getFacebookPages(){try{console.log("Fetching Facebook pages with token:",this.accessToken.substring(0,20)+"...");let e=[],o=`https://graph.facebook.com/v18.0/me/accounts?fields=id,name,access_token&access_token=${this.accessToken}&limit=100`;for(;o;){console.log("Fetching pages from:",o);let s=await fetch(o),t=await s.json();if(console.log("Facebook pages API response:",t),t.error)throw console.error("Facebook pages API error:",t.error),Error(t.error.message);t.data&&Array.isArray(t.data)&&(e=e.concat(t.data),console.log(`âœ… Fetched ${t.data.length} pages in this batch`)),o=t.paging?.next||null}return console.log(`ðŸ“Š Total Facebook pages found: ${e.length}`),e}catch(e){throw console.error("Error fetching Facebook pages:",e),e}}async getInstagramAccounts(e){try{let o=[],s=await fetch(`https://graph.facebook.com/v18.0/${e}?fields=instagram_business_account,connected_instagram_account&access_token=${this.accessToken}`),t=await s.json();if(console.log(`Instagram data for page ${e}:`,t),t.error)return console.error(`Error getting page data for ${e}:`,t.error),[];if(t.instagram_business_account){console.log(`âœ… Found Instagram Business Account for page ${e}`);let s=await fetch(`https://graph.facebook.com/v18.0/${t.instagram_business_account.id}?fields=id,username,name&access_token=${this.accessToken}`),a=await s.json();a.error?console.log(`âŒ Error getting Instagram business details:`,a.error):(o.push(a),console.log(`âœ… Added Instagram Business: ${a.username} (${a.id})`))}if(t.connected_instagram_account&&(!t.instagram_business_account||t.connected_instagram_account.id!==t.instagram_business_account.id)){console.log(`âœ… Found Connected Instagram Account for page ${e}`);let s=await fetch(`https://graph.facebook.com/v18.0/${t.connected_instagram_account.id}?fields=id,username,name&access_token=${this.accessToken}`),a=await s.json();a.error?console.log(`âŒ Error getting connected Instagram details:`,a.error):(o.push(a),console.log(`âœ… Added Connected Instagram: ${a.username} (${a.id})`))}try{let s=await fetch(`https://graph.facebook.com/v18.0/${e}/instagram_accounts?fields=id,username,name&access_token=${this.accessToken}`),t=await s.json();if(!t.error&&t.data&&Array.isArray(t.data))for(let s of(console.log(`âœ… Found ${t.data.length} Instagram accounts through edge for page ${e}`),t.data))o.some(e=>e.id===s.id)||(o.push(s),console.log(`âœ… Added Instagram via edge: ${s.username} (${s.id})`))}catch(o){console.log(`â„¹ï¸  Instagram edge not available for page ${e}:`,o)}return console.log(`ðŸ“Š Total Instagram accounts for page ${e}: ${o.length}`),o}catch(e){throw console.error("Error fetching Instagram accounts:",e),e}}formatMessage(e,o){let s=o.map(e=>`#${e}`).join(" ");return`${e}

${s}`}async validateToken(){try{let e=await fetch(`https://graph.facebook.com/v18.0/me?access_token=${this.accessToken}`),o=await e.json();if(o.error)return{valid:!1,error:o.error.message};return{valid:!0}}catch(e){return{valid:!1,error:e.message}}}}function n(e){return new r(e)}},39727:()=>{},47990:()=>{},78335:()=>{},96487:()=>{}};