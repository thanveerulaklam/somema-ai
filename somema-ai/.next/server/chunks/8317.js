exports.id=8317,exports.ids=[8317],exports.modules={9682:(e,t,r)=>{"use strict";r.d(t,{Hk:()=>N});var n=r(32190),s=r(66437),i=r(49485);let o=(0,s.UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function a(e){try{let{data:t,error:r}=await o.auth.refreshSession({refresh_token:e});if(r)return console.error("Token refresh error:",r),{success:!1,error:"Token refresh failed"};return{success:!0,newToken:t.session?.access_token,newRefreshToken:t.session?.refresh_token,user:t.user}}catch(e){return console.error("Token refresh error:",e),{success:!1,error:"Token refresh failed"}}}async function c(e,t,r={},n){try{let s={user_id:e,action:t,details:r,timestamp:new Date().toISOString(),ip:n?.headers.get("x-forwarded-for")||n?.headers.get("x-real-ip")||"unknown",user_agent:n?.headers.get("user-agent")||"unknown"};console.log("\uD83D\uDD0D User Activity:",s)}catch(e){console.error("Error logging user activity:",e)}}var E=r(14914);let u={AUTH_REQUIRED:"AUTH_REQUIRED",AUTH_INVALID_TOKEN:"AUTH_INVALID_TOKEN",AUTH_TOKEN_EXPIRED:"AUTH_TOKEN_EXPIRED",AUTH_INSUFFICIENT_PERMISSIONS:"AUTH_INSUFFICIENT_PERMISSIONS",VALIDATION_FAILED:"VALIDATION_FAILED",VALIDATION_INVALID_INPUT:"VALIDATION_INVALID_INPUT",VALIDATION_MISSING_FIELD:"VALIDATION_MISSING_FIELD",RATE_LIMIT_EXCEEDED:"RATE_LIMIT_EXCEEDED",PAYMENT_FAILED:"PAYMENT_FAILED",PAYMENT_INVALID_SIGNATURE:"PAYMENT_INVALID_SIGNATURE",PAYMENT_AMOUNT_MISMATCH:"PAYMENT_AMOUNT_MISMATCH",CREDITS_INSUFFICIENT:"CREDITS_INSUFFICIENT",CREDITS_DEDUCTION_FAILED:"CREDITS_DEDUCTION_FAILED",FILE_UPLOAD_FAILED:"FILE_UPLOAD_FAILED",FILE_INVALID_TYPE:"FILE_INVALID_TYPE",FILE_TOO_LARGE:"FILE_TOO_LARGE",DATABASE_ERROR:"DATABASE_ERROR",DATABASE_CONNECTION_FAILED:"DATABASE_CONNECTION_FAILED",EXTERNAL_API_ERROR:"EXTERNAL_API_ERROR",OPENAI_API_ERROR:"OPENAI_API_ERROR",RAZORPAY_API_ERROR:"RAZORPAY_API_ERROR",INTERNAL_SERVER_ERROR:"INTERNAL_SERVER_ERROR",SERVICE_UNAVAILABLE:"SERVICE_UNAVAILABLE",NOT_FOUND:"NOT_FOUND",FORBIDDEN:"FORBIDDEN",BAD_REQUEST:"BAD_REQUEST"},I={[u.AUTH_REQUIRED]:"Authentication required",[u.AUTH_INVALID_TOKEN]:"Invalid or expired token",[u.AUTH_TOKEN_EXPIRED]:"Token has expired",[u.AUTH_INSUFFICIENT_PERMISSIONS]:"Insufficient permissions",[u.VALIDATION_FAILED]:"Validation failed",[u.VALIDATION_INVALID_INPUT]:"Invalid input provided",[u.VALIDATION_MISSING_FIELD]:"Required field is missing",[u.RATE_LIMIT_EXCEEDED]:"Too many requests. Please try again later.",[u.PAYMENT_FAILED]:"Payment processing failed",[u.PAYMENT_INVALID_SIGNATURE]:"Invalid payment signature",[u.PAYMENT_AMOUNT_MISMATCH]:"Payment amount mismatch",[u.CREDITS_INSUFFICIENT]:"Insufficient credits",[u.CREDITS_DEDUCTION_FAILED]:"Credit deduction failed",[u.FILE_UPLOAD_FAILED]:"File upload failed",[u.FILE_INVALID_TYPE]:"Invalid file type",[u.FILE_TOO_LARGE]:"File size too large",[u.DATABASE_ERROR]:"Database operation failed",[u.DATABASE_CONNECTION_FAILED]:"Database connection failed",[u.EXTERNAL_API_ERROR]:"External service error",[u.OPENAI_API_ERROR]:"AI service temporarily unavailable",[u.RAZORPAY_API_ERROR]:"Payment service temporarily unavailable",[u.INTERNAL_SERVER_ERROR]:"Internal server error",[u.SERVICE_UNAVAILABLE]:"Service temporarily unavailable",[u.NOT_FOUND]:"Resource not found",[u.FORBIDDEN]:"Access forbidden",[u.BAD_REQUEST]:"Bad request"};function d(e,t=500,r,s){let i=function(e,t,r){let n=new Date().toISOString();return{error:I[t]||I[u.INTERNAL_SERVER_ERROR],code:t,requestId:r,timestamp:n}}(0,e,r),o=n.NextResponse.json({...i,...s},{status:t});return r&&o.headers.set("X-Request-ID",r),o}function l(e){if("string"==typeof e)return e.replace(/[<>]/g,"").replace(/javascript:/gi,"").replace(/on\w+=/gi,"").trim();if(Array.isArray(e))return e.map(l);if("object"==typeof e&&null!==e){let t={};for(let[r,n]of Object.entries(e))t[r]=l(n);return t}return e}let A=(0,s.UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function _(e){try{let{data:{user:t},error:r}=await A.auth.getUser(e);if(r||!t)return{valid:!1,user:null,error:r?.message||"Invalid token"};return{valid:!0,user:t,error:null}}catch(e){return{valid:!1,user:null,error:"Token validation failed"}}}async function R(e){let t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return n.NextResponse.json({error:"Authorization header required"},{status:401});let r=t.substring(7),s=await _(r);return s.valid?{user:s.user,token:r}:n.NextResponse.json({error:"Invalid or expired token"},{status:401})}async function m(e){let t=await R(e);if(t instanceof n.NextResponse)return t;let{user:r}=t;return r?await (0,i.X2)(r.id)?{user:r,isAdmin:!0}:n.NextResponse.json({error:"Admin access required"},{status:403}):n.NextResponse.json({error:"User not found"},{status:401})}let T=new Map;async function N(e,t={}){let r=`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,{logger:s,metrics:i,performance:o}=(0,E.Gw)(e);try{let{requireAuth:a=!0,requireAdmin:E=!1,rateLimit:I}=t;if(I){let t=function(e){let t=e.headers.get("x-forwarded-for"),r=e.headers.get("x-real-ip");return t?t.split(",")[0].trim():r||"unknown"}(e),n=function(e,t=100,r=9e5){let n=Date.now(),s=T.get(e);return!s||n>s.resetTime?(T.set(e,{count:1,resetTime:n+r}),{allowed:!0,remaining:t-1}):s.count>=t?{allowed:!1,remaining:0,resetTime:s.resetTime}:(s.count++,{allowed:!0,remaining:t-s.count})}(t,I.maxRequests||100,I.windowMs||9e5);if(!n.allowed)return s.warn("Rate limit exceeded",{clientIP:t,rateLimitResult:n}),i.incrementCounter("rate_limit_exceeded",{endpoint:e.nextUrl.pathname}),d(u.RATE_LIMIT_EXCEEDED,429,r,{resetTime:n.resetTime})}if(a)if(E){let t=await m(e);if(t instanceof n.NextResponse)return o.end(!0),t;return t.user&&await c(t.user.id,"admin_access",{endpoint:e.nextUrl.pathname,method:e.method},e),o.end(!1),t}else{let t=await R(e);if(t instanceof n.NextResponse)return o.end(!0),t;return t.user&&await c(t.user.id,"api_access",{endpoint:e.nextUrl.pathname,method:e.method},e),o.end(!1),t}return o.end(!1),{user:null}}catch(e){return s.error("API middleware error",{error:e?.message||"Unknown error",stack:e?.stack}),o.end(!0),d(u.INTERNAL_SERVER_ERROR,500,r)}}},14914:(e,t,r)=>{"use strict";r.d(t,{Gw:()=>u,Zv:()=>I});let n={ERROR:"error",WARN:"warn",INFO:"info",DEBUG:"debug"},s={REQUEST_COUNT:"request_count",RESPONSE_TIME:"response_time",ERROR_COUNT:"error_count"};class i{addLog(e){this.logs.push(e),this.logs.length>1e3&&(this.logs=this.logs.slice(-1e3))}addMetric(e){this.metrics.push(e),this.metrics.length>1e4&&(this.metrics=this.metrics.slice(-1e4))}getLogs(e){return e?this.logs.filter(t=>Object.entries(e).every(([e,r])=>t[e]===r)):this.logs}getMetrics(e){return e?this.metrics.filter(t=>Object.entries(e).every(([e,r])=>t[e]===r)):this.metrics}updatePerformanceMetrics(e,t,r,n){let s=`${t}:${e}`,i=this.performanceMetrics.get(s);i?(i.requestCount++,i.averageResponseTime=(i.averageResponseTime+r)/2,i.errorRate=n?i.errorRate+1:i.errorRate,i.successRate=i.requestCount-i.errorRate,i.lastUpdated=new Date().toISOString()):this.performanceMetrics.set(s,{endpoint:e,method:t,averageResponseTime:r,requestCount:1,errorRate:+!!n,successRate:+!n,lastUpdated:new Date().toISOString()})}getPerformanceMetrics(){return Array.from(this.performanceMetrics.values())}getAlertHistory(e){return this.alertHistory.get(e)||0}setAlertHistory(e,t){this.alertHistory.set(e,t)}constructor(){this.logs=[],this.metrics=[],this.performanceMetrics=new Map,this.alertHistory=new Map}}let o=new i;class a{constructor(e={}){this.context=e}log(e,t,r){let n={timestamp:new Date().toISOString(),level:e,message:t,context:this.context,metadata:r};o.addLog(n)}info(e,t){this.log(n.INFO,e,t)}warn(e,t){this.log(n.WARN,e,t)}error(e,t){this.log(n.ERROR,e,t)}debug(e,t){this.log(n.DEBUG,e,t)}}class c{constructor(e={}){this.context=e}record(e,t,r={}){let n={timestamp:new Date().toISOString(),metric:e,value:t,tags:{...this.context,...r}};o.addMetric(n)}incrementCounter(e,t={}){this.record(e,1,t)}recordGauge(e,t,r={}){this.record(e,t,r)}recordHistogram(e,t,r={}){this.record(e,t,r)}}class E{constructor(e,t,r){this.startTime=Date.now(),this.requestId=e,this.endpoint=t,this.method=r}end(e=!1){let t=Date.now()-this.startTime;o.updatePerformanceMetrics(this.endpoint,this.method,t,e);let r=new c({request_id:this.requestId,endpoint:this.endpoint,method:this.method});return r.recordHistogram(s.RESPONSE_TIME,t),r.incrementCounter(s.REQUEST_COUNT),e&&r.incrementCounter(s.ERROR_COUNT),t}}function u(e){let t=`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,r=e.nextUrl.pathname,n=e.method,s=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown",i=new a({requestId:t,endpoint:r,method:n,ip:s,userAgent:e.headers.get("user-agent")||"unknown"});return{logger:i,metrics:new c({request_id:t,endpoint:r,method:n,ip:s}),performance:new E(t,r,n)}}function I(){let e=o.getPerformanceMetrics(),t=e.reduce((e,t)=>e+t.requestCount,0),r=e.reduce((e,t)=>e+t.errorRate,0),n=t>0?r/t*100:0,s=e.length>0?e.reduce((e,t)=>e+t.averageResponseTime,0)/e.length:0;return{status:n>10?"degraded":"healthy",timestamp:new Date().toISOString(),version:"1.0.0",uptime:process.uptime(),metrics:{totalRequests:t,errorRate:Math.round(100*n)/100,averageResponseTime:Math.round(100*s)/100},dependencies:{database:"healthy",externalAPIs:"healthy"}}}},39727:()=>{},47990:()=>{},49485:(e,t,r)=>{"use strict";r.d(t,{CX:()=>c,X2:()=>o,eM:()=>a});let n=(0,r(66437).UU)("https://yfmypikqgegvookjzvyv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),s=new Map;function i(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}async function o(e){try{if(!i(e))return console.error("❌ Invalid UUID format for admin check:",e),!1;let t=s.get(e);if(t&&Date.now()-t.timestamp<3e5)return console.log("\uD83D\uDD0D Using cached admin check for user:",e,"Result:",t.isAdmin),t.isAdmin;console.log("\uD83D\uDD0D Checking admin access for user:",e);let{data:r,error:o}=await n.rpc("get_user_admin_info",{user_uuid:e});if(o)return console.error("❌ Admin check error:",o),s.set(e,{isAdmin:!1,timestamp:Date.now()}),!1;if(!r||!Array.isArray(r)||0===r.length)return console.log("ℹ️ No admin info found for user:",e),s.set(e,{isAdmin:!1,timestamp:Date.now()}),!1;let a=r[0];if("boolean"!=typeof a.is_admin||"boolean"!=typeof a.is_active)return console.error("❌ Invalid admin data structure:",a),s.set(e,{isAdmin:!1,timestamp:Date.now()}),!1;let c=a.is_admin&&a.is_active;return console.log("✅ Admin check result:",{userId:e,isAdmin:c,role:a.role,isActive:a.is_active}),s.set(e,{isAdmin:c,timestamp:Date.now()}),c}catch(t){return console.error("❌ Error checking admin access:",t),s.set(e,{isAdmin:!1,timestamp:Date.now()}),!1}}async function a(e){return await o(e)}async function c(e){try{if(!i(e))return console.error("❌ Invalid UUID format for admin info check:",e),{isAdmin:!1};let{data:t,error:r}=await n.rpc("get_user_admin_info",{user_uuid:e});if(r||!t||!Array.isArray(t)||0===t.length)return{isAdmin:!1};let s=t[0];if("boolean"!=typeof s.is_admin||"boolean"!=typeof s.is_active)return console.error("❌ Invalid admin data structure:",s),{isAdmin:!1};return{isAdmin:s.is_admin&&s.is_active,role:s.role,permissions:s.permissions}}catch(e){return console.error("Error getting admin info:",e),{isAdmin:!1}}}},78335:()=>{},96487:()=>{}};